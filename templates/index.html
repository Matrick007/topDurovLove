<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>US-21 –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <script src="{{ url_for('static', filename='notification.js') }}"></script>
</head>
<body>
    <div class="telegram-layout">
        <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: —á–∞—Ç—ã –∏ –≥—Ä—É–ø–ø—ã -->
        <div class="chat-list-sidebar" id="chat-list">
            <div class="header">
                <h3>–ß–∞—Ç—ã</h3>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button id="theme-toggle" style="font-size: 16px; background: none; border: none; cursor: pointer; color: var(--text-color);">‚òÄÔ∏è</button>
                    <a href="{{ url_for('logout') }}" class="logout">–í—ã–π—Ç–∏</a>
                </div>
            </div>

            <!-- –ò–∫–æ–Ω–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è -->
            <div class="profile-icon-container">
                <a href="/profile" class="profile-link">
                    <div class="profile-icon">üë§</div>
                    <span>{{ session.username }}</span>
                </a>
            </div>

            <!-- –ü–æ–∏—Å–∫ -->
            <div class="search-container">
                <div class="search-input-wrapper">
                    <input type="text" id="search-input" placeholder="–ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..." class="search-input">
                    <span class="search-icon">üîç</span>
                </div>
                <div id="search-results" style="display: none;"></div>
            </div>
            <!-- –ö–Ω–æ–ø–∫–∞ –õ–µ–Ω—Ç–∞ -->
            <button onclick="openFeed()" style="margin: 12px 16px; padding: 12px 16px; background: var(--accent-color); color: white; border: none; border-radius: 24px; font-size: 14px; font-weight: 500; cursor: pointer; width: calc(100% - 32px); display: flex; align-items: center; justify-content: center; gap: 8px;">üì± –õ–µ–Ω—Ç–∞</button>

            <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã -->
            <button onclick="openCreateGroupModal()" class="create-group-btn">‚ûï –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>

            <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ -->
            <div class="chat-items">
                {% for user in user_chats %}
                    <div class="chat-item" onclick="openChat('{{ user.username }}')" data-room="{% if username|lower < user.username|lower %}{{ username|lower }}_{{ user.username|lower }}{% else %}{{ user.username|lower }}_{{ username|lower }}{% endif %}">
                        <div class="avatar">{{ user.username[0].upper() }}</div>
                        <div class="chat-info">
                            <h4>{{ user.username }}{% if user.unread_count > 0 %}<span class="unread-count">{{ user.unread_count }}</span>{% endif %}</h4>
                            <p>{{ user.last_message|truncate(25, True, '...') or '–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —á–∞—Ç' }}</p>
                        </div>
                    </div>
                {% else %}
                    <p class="no-users">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
                {% endfor %}
            </div>
        </div>

        <!-- –û–∫–Ω–æ —á–∞—Ç–∞ -->
        <div class="chat-window" id="chat-window" style="display: none;">
            <div class="chat-header">
                <button class="back-btn pc" onclick="goBack()">‚Üê –ù–∞–∑–∞–¥</button>
                <button class="back-btn mobile" onclick="goBack()">‚Üê</button>
                <h3 id="chat-username" onclick="openProfile()" style="cursor: pointer; color: #667eea;"></h3>
                <span class="status">–æ–Ω–ª–∞–π–Ω</span>
            </div>
             <div id="pinned-message"></div>
            <div class="messages" id="messages"></div>
            <div class="typing-indicator" id="typing" style="display: none; font-size: 13px; color: #666; padding: 16px; margin-top: -8px;"></div>
            <div class="chat-input">
                <input type="text" id="msg-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." autofocus>
                <button id="emoji-btn">üòä</button>
                <button id="send-btn">‚û§</button>
            </div>
        </div>

        <!-- –û–∫–Ω–æ –ª–µ–Ω—Ç—ã -->
        <div class="feed-window" id="feed-view" style="display: none;">
            <div class="feed-header">
                <button class="back-btn pc" onclick="closeFeed()">‚Üê –ù–∞–∑–∞–¥</button>
                <button class="back-btn mobile" onclick="closeFeed()">‚Üê</button>
                <h3>–õ–µ–Ω—Ç–∞</h3>
            </div>
            <div class="posts-list" id="feed-posts" style="padding: 20px; overflow-y: auto; height: calc(100vh - 60px);"></div>
        </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è —á–∞—Ç–∞ -->
    <div id="chat-context-menu" style="display: none; position: absolute; background: white; border: 1px solid #ccc; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; border-radius: 8px; overflow: hidden;">
        <div onclick="deleteCurrentChat()" style="padding: 12px 16px; cursor: pointer;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —á–∞—Ç</div>
    </div>

    <!-- –≠–º–æ–¥–∑–∏-–ø–∞–ª–∏—Ç—Ä–∞ -->
<div id="emoji-picker" style="display: none; grid-template-columns: repeat(8, 1fr); gap: 8px; padding: 10px; background: var(--header-bg); border-radius: 12px; position: absolute; bottom: 70px; right: 20px; z-index: 10; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
    <span class="emoji-btn">üòä</span>
    <span class="emoji-btn">üòÇ</span>
    <span class="emoji-btn">‚ù§Ô∏è</span>
    <span class="emoji-btn">üî•</span>
    <span class="emoji-btn">üöÄ</span>
    <span class="emoji-btn">üëç</span>
    <span class="emoji-btn">üéâ</span>
    <span class="emoji-btn">üëè</span>
    <span class="emoji-btn">üòé</span>
    <span class="emoji-btn">ü§î</span>
    <span class="emoji-btn">üí°</span>
    <span class="emoji-btn">üëÄ</span>
    <span class="emoji-btn">üôè</span>
    <span class="emoji-btn">üèÜ</span>
    <span class="emoji-btn">ü§ù</span>
    <span class="emoji-btn">‚ú®</span>
</div>

<script>
    const username = "{{ session.username }}";
    const userChats = {{ user_chats|tojson|safe }};
    let currentRoom = null;
    let socket = null;
    let userStatuses = {}; // username ‚Üí { status: 'online', lastSeen: Date }
    let currentChatId = null;
    let currentGroupId = null;

    socket = io({
        transports: ['polling']
    });

    window.chatSocket = socket;

    // === –ó–í–£–ö–ò ===
    function playMessageSound() {
        const audio = new Audio('{{ url_for("static", filename="message.mp3") }}');
        audio.play().catch(() => {});
    }

    function playChatSound() {
        const audio = new Audio('{{ url_for("static", filename="chat.mp3") }}');
        audio.play().catch(() => {});
    }

    // === –°–û–û–ë–©–ï–ù–ò–Ø ===
    socket.on('connect', () => {
        console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ');
    });

    // === –°—Ç–∞—Ç—É—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ===
    socket.on('user_status_update', (data) => {
        userStatuses[data.user] = {
            status: data.status,
            lastSeen: new Date()
        };
        updateChatListStatus();
    });

function updateChatListStatus() {
    document.querySelectorAll('.chat-item').forEach(el => {
        const user = el.querySelector('h4').textContent.replace('#', '').trim();
        const status = userStatuses[user] ? userStatuses[user].status : 'offline';
        const statusEl = el.querySelector('.status-dot');
        if (statusEl) {
            statusEl.style.background = status === 'online' ? '#07a74e' : '#ccc';
        }
    });
}

    // === "–ü–ï–ß–ê–¢–ê–ï–¢" ===
    socket.on('typing', function(data) {
        if (data.sender !== username) {
            document.getElementById('typing').style.display = 'block';
            document.getElementById('typing').textContent = data.sender + ' –ø–µ—á–∞—Ç–∞–µ—Ç...';
        }
    });

    socket.on('stop_typing', function() {
        document.getElementById('typing').style.display = 'none';
    });

    function addMessageToChat(msg, isGroup = false) {
        const messagesDiv = document.getElementById('messages');
        const el = document.createElement('div');
        el.className = 'message ' + (msg.sender === username ? 'sent' : 'received');
        el.dataset.msgId = msg.id || ('temp_' + Date.now());
        el.dataset.sender = msg.sender;

        let senderName = '';
        if (isGroup && msg.sender !== username) {
            senderName = `<div class="sender-name">${msg.sender}</div>`;
        }

        let check = '';
        if (msg.sender === username) {
            if (msg.is_read || msg.status === 'read') {
                check = '<span class="check read">‚úì‚úì</span>';
            } else if (msg.status === 'delivered') {
                check = '<span class="check delivered">‚úì‚úì</span>';
            } else {
                check = '<span class="check">‚úì‚úì</span>';
            }
        }

        let controls = '';
        if (msg.sender === username) {
            controls = '<span class="msg-control delete">üóëÔ∏è</span>';
        }

        el.innerHTML = `
            ${senderName}
            <p>${msg.message || msg.msg}</p>
            <span class="time">${msg.timestamp || new Date().toLocaleTimeString('ru-RU', { timeZone: 'Europe/Moscow', hour: '2-digit', minute: '2-digit' })}</span>
            ${check}
            ${controls}
        `;
        messagesDiv.appendChild(el);
    }

    // === –ü–û–õ–£–ß–ï–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø ===
    socket.on('receive_message', function(data) {
        console.log('Receive message in', data.room, 'current', currentRoom, 'msg', data.msg);
        if (currentRoom === data.room) {
            addMessageToChat(data, currentRoom && currentRoom.startsWith('group_'));
            scrollToBottom();
            // –ó–≤—É–∫
            if (data.sender !== username) {
                playChatSound();
            }
        } else {
            // –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –¥—Ä—É–≥–æ–º —á–∞—Ç–µ - –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
            updateChatNotification(data.room, data.sender !== username);
            // –ó–≤—É–∫
            if (data.sender !== username) {
                playMessageSound();
                if (!document.hasFocus()) {
                    showNotification(data.sender, data.msg);
                }
            }
        }
    });

    // === –£–î–ê–õ–ï–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø ===
    socket.on('message_deleted', function(data) {
        const msg = document.getElementById('messages').querySelector(`[data-msg-id="${data.msg_id}"]`);
        if (msg) {
            msg.innerHTML = '<p><i>–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ</i></p>';
            msg.classList.add('deleted');
            msg.querySelector('.msg-control')?.remove();
        }
    });

    // === –ì–ê–õ–û–ß–ö–ò ===
    socket.on('message_status', function(data) {
        if (data.room && data.room !== currentRoom) return;
        const msg = document.getElementById('messages').querySelector(`[data-msg-id="${data.msg_id}"]`);
        if (msg) {
            const check = msg.querySelector('.check');
            if (data.status === 'delivered') {
                check.className = 'check delivered';
            } else if (data.status === 'read') {
                check.className = 'check read';
            }
        }
    });

    // === –ó–ê–ö–†–ï–ü ===
    socket.on('pinned_message', function(data) {
        if (currentRoom === `group_${data.group}`) {
            const pinned = document.getElementById('pinned-message');
            pinned.innerHTML = `
                <div style="font-size: 12px; color: #666; margin: 10px 0; padding: 8px 12px; background: var(--header-bg); border-left: 3px solid var(--accent-color); border-radius: 4px;">
                    –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: "${data.msg_id}"
                    <span onclick="unpinMessage('${data.group}')" style="float: right; cursor: pointer; opacity: 0.6;">‚úï</span>
                </div>
            `;
        }
    });

    socket.on('unpinned_message', function(data) {
        if (currentRoom === `group_${data.group}`) {
            document.getElementById('pinned-message').innerHTML = '';
        }
    });

    function openChat(otherUser) {
        document.getElementById('chat-username').textContent = otherUser;
        const room = [username, otherUser].sort().join('_').toLowerCase();
        currentRoom = room;

        _openChatCommon(room, false, otherUser);
    }

    function openGroup(groupName) {
        document.getElementById('chat-username').textContent = `# ${groupName}`;
        const room = `group_${groupName}`;
        currentRoom = room;

        _openChatCommon(room, true, null);
    }

    function _openChatCommon(room, isGroup, otherUser) {
        // –°–∫—Ä—ã–≤–∞—Ç—å sidebar —Ç–æ–ª—å–∫–æ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
        if (window.innerWidth < 768) {
            document.getElementById('chat-list').style.display = 'none';
        }
        document.getElementById('chat-window').style.display = 'flex';
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = '';
        document.getElementById('typing').style.display = 'none';
        document.getElementById('pinned-message').innerHTML = '';

        socket.emit('set_chat_context', { room: room });
        socket.emit('join', { room: room });
        updateChatNotification(room, false); // –£–±—Ä–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        loadChatList(); // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫, —á—Ç–æ–±—ã —Å–±—Ä–æ—Å–∏—Ç—å unread_count

        // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –≥–∞–ª–æ—á–∫–∏ –Ω–∞ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ
        setTimeout(() => {
            console.log('Updating checks to read');
            document.querySelectorAll('.message.sent .check').forEach(check => {
                check.className = 'check read';
            });
        }, 100); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

        const url = isGroup
            ? `/group/${room.replace('group_', '')}/history`
            : `/chat/${room.split('_').find(u => u !== username)}/history`;

        fetch(url)
            .then(r => r.json())
            .then(data => {
                if (isGroup) {
                    currentGroupId = data.group_id;
                    currentChatId = null;
                } else {
                    currentChatId = data.chat_id;
                    currentGroupId = null;
                }

                if (data.pinned) {
                    document.getElementById('pinned-message').innerHTML = `
                        <div style="font-size: 12px; color: #666; margin: 10px 0; padding: 8px 12px; background: var(--header-bg); border-left: 3px solid var(--accent-color); border-radius: 4px;">
                            –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: "${data.pinned.message}"
                            <span onclick="unpinMessage('${room.replace('group_', '')}')" style="float: right; cursor: pointer; opacity: 0.6;">‚úï</span>
                        </div>
                    `;
                }

                if (!isGroup && data.messages.length === 0) {
                    // –ù–æ–≤—ã–π —á–∞—Ç, —É–≤–µ–¥–æ–º–∏—Ç—å –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    socket.emit('new_chat', { with: otherUser });
                }

                console.log('Loaded messages', data.messages.length, 'for room', room);
                data.messages.forEach(msg => {
                    addMessageToChat(msg, isGroup);
                });
                scrollToBottom();
            });

        // –û—á–∏—Å—Ç–∫–∞
        ['receive_message', 'message_status', 'typing', 'stop_typing', 'message_deleted', 'pinned_message', 'unpinned_message'].forEach(e => socket.off(e));

        // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º
        socket.on('receive_message', function(data) {
            addMessageToChat(data, isGroup);
            scrollToBottom();

            if (data.sender !== username) {
                if (currentRoom === data.room) {
                    playChatSound();
                } else {
                    playMessageSound();
                    if (!document.hasFocus()) {
                        showNotification(data.sender, data.msg);
                    }
                }
            }
        });

        socket.on('message_deleted', function(data) {
            const msg = messagesDiv.querySelector(`[data-msg-id="${data.msg_id}"]`);
            if (msg) {
                msg.innerHTML = '<p><i>–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ</i></p>';
                msg.classList.add('deleted');
                msg.querySelector('.msg-control')?.remove();
            }
        });

        socket.on('message_status', function(data) {
            if (data.room && data.room !== currentRoom) return;
            const msg = messagesDiv.querySelector(`[data-msg-id="${data.msg_id}"]`);
            if (msg) {
                const check = msg.querySelector('.check');
                if (data.status === 'delivered') {
                    check.className = 'check delivered';
                } else if (data.status === 'read') {
                    check.className = 'check read';
                }
            }
        });

        socket.on('pinned_message', function(data) {
            document.getElementById('pinned-message').innerHTML = `
                <div style="font-size: 12px; color: #666; margin: 10px 0; padding: 8px 12px; background: var(--header-bg); border-left: 3px solid var(--accent-color); border-radius: 4px;">
                    –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: "${data.msg_id}"
                    <span onclick="unpinMessage('${data.group}')" style="float: right; cursor: pointer; opacity: 0.6;">‚úï</span>
                </div>
            `;
        });

        socket.on('unpinned_message', function(data) {
            document.getElementById('pinned-message').innerHTML = '';
        });

        socket.on('typing', function(data) {
            if (data.sender !== username) {
                document.getElementById('typing').style.display = 'block';
                document.getElementById('typing').textContent = data.sender + ' –ø–µ—á–∞—Ç–∞–µ—Ç...';
            }
        });

        socket.on('stop_typing', function() {
            document.getElementById('typing').style.display = 'none';
        });

        // –£–¥–∞–ª–µ–Ω–∏–µ
        messagesDiv.addEventListener('click', function(e) {
            if (e.target.classList.contains('delete')) {
                const msgId = e.target.closest('.message').dataset.msgId;
                if (msgId && msgId.startsWith('temp_')) return;
                if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
                    socket.emit('delete_message', { msg_id: msgId, room: currentRoom });
                }
            }
        });

        // –û—Ç–ø—Ä–∞–≤–∫–∞
        document.getElementById('send-btn').onclick = function() {
            const msg = document.getElementById('msg-input').value.trim();
            if (msg) {
                socket.emit('send_message', { room: room, msg: msg });
                document.getElementById('msg-input').value = '';
            }
        };

        // –ó–∞–∫—Ä–µ–ø
        messagesDiv.addEventListener('contextmenu', function(e) {
            if (e.target.closest('.message') && currentRoom.startsWith('group_')) {
                e.preventDefault();
                const msgId = e.target.closest('.message').dataset.msgId;
                if (msgId && !msgId.startsWith('temp_') && confirm('–ó–∞–∫—Ä–µ–ø–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
                    const group = currentRoom.replace('group_', '');
                    socket.emit('pin_message', { group: group, msg_id: msgId });
                }
            }
        });

        // –≠–º–æ–¥–∑–∏
        document.getElementById('emoji-btn').onclick = () => {
            const picker = document.getElementById('emoji-picker');
            picker.style.display = picker.style.display === 'grid' ? 'none' : 'grid';
        };

        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('emoji-btn')) {
                const input = document.getElementById('msg-input');
                if (input) {
                    input.value += e.target.textContent;
                    input.focus();
                }
            }
        });

        scrollToBottom();
        requestNotificationPermission();
    }

    function unpinMessage(group) {
        if (confirm('–û—Ç–∫—Ä–µ–ø–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
            socket.emit('unpin_message', { group: group });
        }
    }

    function createGroup() {
        const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã:");
        if (name) {
            socket.emit('create_group', { name: name });
        }
    }

    function openProfile() {
        const username = document.getElementById('chat-username').textContent.trim();
        if (username && !username.startsWith('#')) {
            window.location.href = '/profile/' + username;
        }
    }

    function goBack() {
        document.getElementById('chat-list').style.display = 'flex';
        document.getElementById('chat-window').style.display = 'none';
        document.getElementById('feed-view').style.display = 'none';
        currentRoom = null;
        socket.emit('set_chat_context', { room: '' });
    }

    function openFeed() {
        if (window.innerWidth < 768) {
            document.getElementById('chat-list').style.display = 'none';
        }
        document.getElementById('chat-window').style.display = 'none';
        document.getElementById('feed-view').style.display = 'flex';
        loadFeed();
    }

    function closeFeed() {
        document.getElementById('feed-view').style.display = 'none';
        document.getElementById('chat-list').style.display = 'flex';
    }

    function loadFeed() {
        fetch('/feed_data')
        .then(r => r.json())
        .then(data => {
            const container = document.getElementById('feed-posts');
            container.innerHTML = '';
            data.feed.forEach(post => {
                const postEl = document.createElement('div');
                postEl.className = 'post';
                postEl.innerHTML = `
                    <div class="post-content">
                        <strong>${post.username}</strong>
                        <p class="post-text">${post.content}</p>
                        ${post.image_url ? `<img class="post-thumbnail" src="/uploads/${post.image_url}" alt="Post image" onclick="openPostModal('${post.id}', '${post.content.replace(/'/g, "\\'")}', '${post.image_url}')">` : ''}
                        <div class="post-actions">
                            <button class="action-btn like-btn" onclick="toggleLike('${post.id}', this)">‚ù§Ô∏è ${post.likes_count || 0}</button>
                            <button class="action-btn comment-btn" onclick="showComments('${post.id}')">üí¨ ${post.comments_count || 0}</button>
                            <button class="action-btn repost-btn" onclick="toggleRepost('${post.id}', this)">üîÑ ${post.reposts_count || 0}</button>
                        </div>
                    </div>
                `;
                container.appendChild(postEl);
            });
        });
    }

    function openPostModal(id, content, imageUrl) {
        document.getElementById('post-modal-content').textContent = content;
        document.getElementById('post-modal-image').src = '/uploads/' + imageUrl;
        document.getElementById('post-modal').style.display = 'flex';
    }

    function closePostModal() {
        document.getElementById('post-modal').style.display = 'none';
    }

    async function toggleLike(postId, btn) {
        const isLiked = btn.style.color === 'rgb(231, 76, 60)';
        const endpoint = isLiked ? '/unlike/' : '/like/';
        const res = await fetch(endpoint + postId, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
            btn.style.color = isLiked ? '#666' : '#e74c3c';
            const match = btn.textContent.match(/(\d+)/);
            const currentCount = match ? parseInt(match[0]) : 0;
            const count = currentCount + (isLiked ? -1 : 1);
            btn.innerHTML = btn.innerHTML.replace(/\d+/, count);
        }
    }

    async function toggleRepost(postId, btn) {
        const isReposted = btn.style.color === 'rgb(52, 152, 219)';
        const endpoint = isReposted ? '/unrepost/' : '/repost/';
        const res = await fetch(endpoint + postId, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
            btn.style.color = isReposted ? '#666' : '#3498db';
            const match = btn.textContent.match(/(\d+)/);
            const currentCount = match ? parseInt(match[0]) : 0;
            const count = currentCount + (isReposted ? -1 : 1);
            btn.innerHTML = btn.innerHTML.replace(/\d+/, count);
        }
    }

    function showComments(postId) {
        alert('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã');
    }

    function scrollToBottom() {
        const div = document.getElementById('messages');
        div.scrollTop = div.scrollHeight;
    }

    window.onload = () => {
        const isDark = localStorage.getItem('theme') === 'dark';
        if (isDark) document.body.classList.add('dark');
        document.getElementById('theme-toggle').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';

        if (window.innerWidth >= 768) {
            document.getElementById('chat-list').style.display = 'flex';
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter
        document.getElementById('msg-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('send-btn').click();
            }
        });

        const groupsContainer = document.querySelector('.chat-items');
        const userGroupsRaw = '{{ user_groups|tojson|safe }}';
        const userGroups = userGroupsRaw ? JSON.parse(userGroupsRaw) : [];

        if (Array.isArray(userGroups) && groupsContainer) {
            userGroups.forEach(g => {
                const el = document.createElement('div');
                el.className = 'chat-item';
                el.dataset.room = `group_${g.name}`;
                el.onclick = () => openGroup(g.name);
                el.innerHTML = `
                    <div class="avatar">#</div>
                    <div class="chat-info">
                        <h4>#${g.name}${g.unread_count > 0 ? `<span class="unread-count">${g.unread_count}</span>` : ''}</h4>
                        <p>${g.last_message ? g.last_message.substring(0, 25) + (g.last_message.length > 25 ? '...' : '') : '–ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç'}</p>
                    </div>
                    <div class="status-dot" style="width: 10px; height: 10px; border-radius: 50%; background: #ccc;"></div>
                `;
                groupsContainer.appendChild(el);
            });
        }

        updateChatListStatus();
    };

    document.getElementById('theme-toggle').onclick = () => {
        const isDark = document.body.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        document.getElementById('theme-toggle').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
    };

    // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
    window.addEventListener('load', function() {
        const searchInput = document.getElementById('search-input');
        const resultsDiv = document.getElementById('search-results');
        console.log('searchInput:', searchInput);
        console.log('resultsDiv:', resultsDiv);

        if (searchInput && resultsDiv) {
            searchInput.addEventListener('input', function() {
                performSearch();
            });

            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è Enter, –Ω–æ —Å–µ–π—á–∞—Å input —É–∂–µ –∏—â–µ—Ç
                }
            });

            function performSearch() {
                const query = searchInput.value.trim();
                if (query.length < 2) {
                    resultsDiv.style.display = 'none';
                    return;
                }
                fetch('/search_users?q=' + encodeURIComponent(query))
                .then(r => r.json())
                .then(data => {
                    resultsDiv.innerHTML = '';
                    if (data.users.length > 0) {
                        data.users.forEach(user => {
                            const div = document.createElement('div');
                            div.textContent = user.username;
                            div.onclick = () => {
                                openChat(user.username);
                                resultsDiv.style.display = 'none';
                                searchInput.value = '';
                            };
                            resultsDiv.appendChild(div);
                        });
                        resultsDiv.style.display = 'block';
                    } else {
                        resultsDiv.style.display = 'none';
                    }
                });
            }

            document.addEventListener('click', function(e) {
                if (!e.target.closest('#search-input') && !e.target.closest('#search-results')) {
                    resultsDiv.style.display = 'none';
                }
            });
        }
    });

    // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è —á–∞—Ç–∞
    document.addEventListener('contextmenu', function(e) {
        if (e.target.closest('.chat-window') && currentRoom) {
            e.preventDefault();
            const menu = document.getElementById('chat-context-menu');
            menu.style.display = 'block';
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
        }
    });

    document.addEventListener('click', function(e) {
        if (!e.target.closest('#chat-context-menu')) {
            document.getElementById('chat-context-menu').style.display = 'none';
        }
    });

    function deleteCurrentChat() {
        document.getElementById('chat-context-menu').style.display = 'none';
        openDeleteModal();
    }

    function openDeleteModal() {
        const modal = document.getElementById('delete-modal');
        const title = modal.querySelector('h3');
        const desc = modal.querySelector('p');

        if (currentChatId) {
            title.textContent = '–£–¥–∞–ª–∏—Ç—å —á–∞—Ç?';
            desc.textContent = '–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —ç—Ç–æ–º —á–∞—Ç–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –Ω–∞–≤—Å–µ–≥–¥–∞. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.';
        } else if (currentGroupId) {
            title.textContent = '–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É?';
            desc.textContent = '–ì—Ä—É–ø–ø–∞ –∏ –≤—Å–µ –µ—ë —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –Ω–∞–≤—Å–µ–≥–¥–∞. –£—á–∞—Å—Ç–Ω–∏–∫–∏ –ø–æ—Ç–µ—Ä—è—é—Ç –¥–æ—Å—Ç—É–ø. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.';
        }

        modal.style.display = 'flex';
    }

    function closeDeleteModal() {
        document.getElementById('delete-modal').style.display = 'none';
    }

    function confirmDelete() {
        if (currentChatId) {
            fetch('/delete_chat/' + currentChatId, { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    closeDeleteModal();
                    goBack();
                    location.reload(); // –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            });
        } else if (currentGroupId) {
            const groupName = currentRoom.replace('group_', '');
            fetch('/delete_group/' + groupName, { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    closeDeleteModal();
                    goBack();
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            });
        }
    }

    function openCreateGroupModal() {
        document.getElementById('create-group-modal').style.display = 'flex';
        document.getElementById('group-name-input').focus();
        loadGroupMembers();
    }

    function closeCreateGroupModal() {
        document.getElementById('create-group-modal').style.display = 'none';
        document.getElementById('group-name-input').value = '';
        document.getElementById('group-members').innerHTML = '';
    }

    function loadGroupMembers() {
        const membersDiv = document.getElementById('group-members');
        membersDiv.innerHTML = '';
        // –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∫–æ—Ç–æ—Ä—ã–º–∏ –µ—Å—Ç—å —á–∞—Ç
        userChats.forEach(user => {
            const label = document.createElement('label');
            label.style.display = 'flex';
            label.style.alignItems = 'center';
            label.style.marginBottom = '8px';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = user.username;
            checkbox.style.marginRight = '8px';
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.textContent = user.username[0].toUpperCase();
            avatar.style.width = '32px';
            avatar.style.height = '32px';
            avatar.style.marginRight = '8px';
            const name = document.createElement('span');
            name.textContent = user.username;
            label.appendChild(checkbox);
            label.appendChild(avatar);
            label.appendChild(name);
            membersDiv.appendChild(label);
        });
    }

    function createGroup() {
        const name = document.getElementById('group-name-input').value.trim();
        if (!name) return;
        const selectedMembers = Array.from(document.querySelectorAll('#group-members input[type="checkbox"]:checked')).map(cb => cb.value);
        socket.emit('create_group', { name: name, members: selectedMembers });
        closeCreateGroupModal();
    }

    // –°–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –Ω–æ–≤–æ–π –≥—Ä—É–ø–ø—ã
    socket.on('group_created', function(data) {
        if (data.name) {
            addGroupToList(data.name);
        }
    });

    socket.on('update_chat_list', () => {
        loadChatList();
    });

    function loadChatList() {
        fetch('/chat_list')
        .then(r => r.json())
        .then(data => {
            const container = document.querySelector('.chat-items');
            container.innerHTML = '';

            // –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            data.user_chats.forEach(user => {
                const el = document.createElement('div');
                el.className = 'chat-item';
                el.dataset.room = [username, user.username].sort().join('_').toLowerCase();
                el.onclick = () => openChat(user.username);
                el.innerHTML = `
                    <div class="avatar">${user.username[0].toUpperCase()}</div>
                    <div class="chat-info">
                        <h4>${user.username}${user.unread_count > 0 ? `<span class="unread-count">${user.unread_count}</span>` : ''}</h4>
                        <p>${user.last_message ? user.last_message.substring(0, 25) + (user.last_message.length > 25 ? '...' : '') : '–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —á–∞—Ç'}</p>
                    </div>
                `;
                container.appendChild(el);
            });

            // –î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—ã
            data.user_groups.forEach(g => {
                const el = document.createElement('div');
                el.className = 'chat-item';
                el.dataset.room = `group_${g.name}`;
                el.onclick = () => openGroup(g.name);
                el.innerHTML = `
                    <div class="avatar">#</div>
                    <div class="chat-info">
                        <h4>#${g.name}${g.unread_count > 0 ? `<span class="unread-count">${g.unread_count}</span>` : ''}</h4>
                        <p>${g.last_message ? g.last_message.substring(0, 25) + (g.last_message.length > 25 ? '...' : '') : '–ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç'}</p>
                    </div>
                    <div class="status-dot" style="width: 10px; height: 10px; border-radius: 50%; background: #ccc;"></div>
                `;
                container.appendChild(el);
            });

            updateChatListStatus();
        });
    }

    function addGroupToList(groupName) {
        // –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã, loadChatList –æ–±–Ω–æ–≤–∏—Ç –≤—Å—ë
        loadChatList();
    }

    function updateChatNotification(room, hasNew = true) {
        console.log('updateChatNotification', room, hasNew);
        const chatItem = document.querySelector(`.chat-item[data-room="${room}"]`);
        console.log('chatItem', chatItem);
        if (chatItem) {
            if (hasNew) {
                let badge = chatItem.querySelector('.new-msg-badge');
                if (!badge) {
                    badge = document.createElement('span');
                    badge.className = 'new-msg-badge';
                    badge.textContent = '‚Ä¢';
                    chatItem.querySelector('.chat-info').appendChild(badge);
                }
                chatItem.classList.add('has-new-msg');
            } else {
                chatItem.querySelector('.new-msg-badge')?.remove();
                chatItem.classList.remove('has-new-msg');
            }
        }
    }
</script>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã -->
<div id="create-group-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: var(--bg-color); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); width: 400px; max-width: 90%;">
        <h3 style="margin-top: 0; color: var(--text-color);">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</h3>
        <input type="text" id="group-name-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-color); box-sizing: border-box;">
        <div style="margin-top: 20px;">
            <h4 style="margin: 0 0 10px 0; color: var(--text-color);">–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h4>
            <div id="group-members" style="max-height: 200px; overflow-y: auto;"></div>
        </div>
        <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
            <button onclick="closeCreateGroupModal()" style="padding: 10px 20px; border: none; border-radius: 8px; background: #ccc; cursor: pointer;">–û—Ç–º–µ–Ω–∞</button>
            <button onclick="createGroup()" style="padding: 10px 20px; border: none; border-radius: 8px; background: var(--accent-color); color: white; cursor: pointer;">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–¥–∞–ª–µ–Ω–∏—è —á–∞—Ç–∞/–≥—Ä—É–ø–ø—ã -->
<div id="delete-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: var(--bg-color); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); width: 400px; max-width: 90%;">
        <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 48px; color: #ff6b6b;">üóëÔ∏è</div>
        </div>
        <h3 style="margin-top: 0; color: var(--text-color);">–£–¥–∞–ª–∏—Ç—å —á–∞—Ç?</h3>
        <p style="color: #666; margin: 10px 0; line-height: 1.5;">–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —ç—Ç–æ–º —á–∞—Ç–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –Ω–∞–≤—Å–µ–≥–¥–∞. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
        <div style="display: flex; justify-content: center; gap: 10px;">
            <button onclick="closeDeleteModal()" style="padding: 10px 20px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-color); color: var(--text-color); cursor: pointer;">–û—Ç–º–µ–Ω–∞</button>
            <button onclick="confirmDelete()" style="padding: 10px 20px; border: none; border-radius: 8px; background: #ff6b6b; color: white; cursor: pointer; font-weight: 500;">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ—Å—Ç–∞ -->
<div id="post-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: var(--chat-bg); border: 1px solid var(--border-color); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); max-width: 500px; max-height: 80%; overflow-y: auto; position: relative;">
        <button onclick="closePostModal()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-color);">√ó</button>
        <p id="post-modal-content" style="margin: 0 0 15px; font-size: 16px; line-height: 1.5;"></p>
        <img id="post-modal-image" style="max-width: 100%; border-radius: 8px;" alt="Post image">
    </div>
</div>

</body>
</html>