<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sofia</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="{{ url_for('static', filename='notification.js') }}"></script>
    <script>
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedTheme();
        });
    </script>
    <style>
        /* –°–¢–†–û–ì–ò–ô –ò –ü–†–ò–í–õ–ï–ö–ê–¢–ï–õ–¨–ù–´–ô –î–ò–ó–ê–ô–ù –õ–ï–ù–¢–´ */
        .feed-container {
            max-width: none;
            width: 100%;
            margin: 0 auto;
            padding: 40px 20px;
            position: relative;
            z-index: 1;
        }

        .feed-header {
            text-align: center;
            margin-bottom: 50px;
            position: relative;
        }

        .feed-title {
            font-size: 56px;
            font-weight: 900;
            margin: 0;
            background: linear-gradient(45deg, #ffffff 0%, #667eea 30%, #764ba2 60%, #f093fb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -2px;
            text-shadow: 0 0 40px rgba(102, 126, 234, 0.5);
            animation: titlePulse 4s ease-in-out infinite;
            position: relative;
        }

        @keyframes titlePulse {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.02); filter: brightness(1.1); }
        }

        .feed-title::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1), rgba(240, 147, 251, 0.1));
            border-radius: 20px;
            z-index: -1;
            animation: titleGlow 3s ease-in-out infinite alternate;
        }

        @keyframes titleGlow {
            0% { opacity: 0.3; transform: scale(0.95); }
            100% { opacity: 0.6; transform: scale(1.05); }
        }

        .feed-subtitle {
            color: rgba(255, 255, 255, 0.7);
            font-size: 20px;
            margin: 20px 0 0;
            font-weight: 400;
            letter-spacing: 0.5px;
        }

        .posts-list {
            display: block;
        }

        .post {
            margin-bottom: 32px;
            width: auto;
            min-width: 100%;
        }

        .post {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow:
                0 25px 50px rgba(0, 0, 0, 0.25),
                0 0 0 1px rgba(255, 255, 255, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            min-height: 300px;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            cursor: pointer;
            border-radius: 24px 24px 0 0;
        }

        .post[data-post-id] {
            position: relative;
        }

        .post::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg,
                #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57, #ff9ff3, #54a0ff, #5f27cd,
                #00d2d3, #ff9f43, #ee5a24, #0abde3, #10ac84, #f368e0, #ffb142
            );
            background-size: 200% 100%;
            animation: neonRainbow 8s linear infinite;
            border-radius: 24px 24px 0 0;
        }

        @keyframes neonRainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 200% 50%; }
        }

        .post:hover {
            transform: translateY(-12px) scale(1.02);
            box-shadow:
                0 40px 80px rgba(0, 0, 0, 0.3),
                0 0 30px rgba(102, 126, 234, 0.2),
                0 0 0 1px rgba(255, 255, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .post:hover::before {
            height: 6px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        }

        .post-header {
            padding: 28px 28px 0;
            display: flex;
            align-items: center;
            gap: 16px;
            border-radius: 24px 24px 0 0;
        }

        .post-author {
            font-weight: 700;
            font-size: 20px;
            color: var(--text-color);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        .post-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            position: relative;
        }

        .post-avatar::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2, #f093fb, #f5576c);
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .post:hover .post-avatar::before {
            opacity: 1;
        }

        .post-date {
            font-size: 15px;
            color: rgba(255, 255, 255, 0.8);
            margin-left: auto;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 12px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 6px;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            animation: dateGlow 5s ease-in-out infinite;
        }

        @keyframes dateGlow {
            0%, 100% { box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
            50% { box-shadow: 0 2px 12px rgba(102, 126, 234, 0.4); }
        }

        .post-content {
            padding: 20px 28px;
            position: relative;
        }

        .post-text {
            margin: 0 0 20px;
            font-size: 17px;
            line-height: 1.7;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

.image-container {
    width: 100%;
    overflow: hidden;
    border-radius: 1px;
    border: 1px solid rgba(63, 60, 60, 0.1);
    box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    margin: 20px 0;
    background: rgba(0, 0, 0, 0.05);
}

.post-thumbnail {
    width: 100%;
    height: auto;
    cursor: pointer;
    transition: all 0.4s ease;
    display: block;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    object-fit: contain;
}
/* –ü—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
.post-thumbnail:hover {
    transform: scale(1.02);
    box-shadow: 0 12px 32px rgba(0,0,0,0.4);
}

/* –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
.image-container.vertical-image .post-thumbnail {
    max-height: 600px;
    width: auto;
    max-width: 100%;
}

        .post-actions {
            display: flex;
            gap: 12px;
            align-items: center;
            padding: 20px 28px 28px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 0 0 24px 24px;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            padding: 12px 20px;
            border-radius: 16px;
            color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            justify-content: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            color: white;
            border-color: rgba(255, 255, 255, 0.3);
        }

        .action-btn:hover::before {
            left: 100%;
        }

        .like-btn:hover { color: #ff6b6b; border-color: #ff6b6b; box-shadow: 0 0 20px rgba(255, 107, 107, 0.3); }
        .comment-btn:hover { color: #74b9ff; border-color: #74b9ff; box-shadow: 0 0 20px rgba(116, 185, 255, 0.3); }
        .repost-btn:hover { color: #00b894; border-color: #00b894; box-shadow: 0 0 20px rgba(0, 184, 148, 0.3); }
        .react-btn:hover { color: #ffd93d; border-color: #ffd93d; box-shadow: 0 0 20px rgba(255, 217, 61, 0.3); }
        .pin-btn:hover { color: #fd79a8; border-color: #fd79a8; box-shadow: 0 0 20px rgba(253, 121, 168, 0.3); }
        .forward-btn:hover { color: #a29bfe; border-color: #a29bfe; box-shadow: 0 0 20px rgba(162, 155, 254, 0.3); }

        .post-comments-link {
            padding: 15px 28px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.01);
        }

        .show-comments-btn {
            background: rgba(102, 126, 234, 0.8);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .show-comments-btn:hover {
            background: rgba(102, 126, 234, 1);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .reactions {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .reaction {
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
        }

        .reaction-picker {
            position: absolute;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.9) 100%);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            max-width: 200px;
        }

        .emoji-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .emoji-btn:hover {
            background: rgba(0,0,0,0.1);
        }

        .post-menu {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            z-index: 1000;
            overflow: hidden;
        }

        .post-menu div {
            padding: 10px 15px;
            cursor: pointer;
            color: white;
            transition: background 0.2s;
        }

        .post-menu div:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            margin: 80px auto 0;
            padding: 18px 40px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.8) 0%, rgba(118, 75, 162, 0.8) 100%);
            color: white;
            text-decoration: none;
            font-size: 18px;
            font-weight: 700;
            border-radius: 20px;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        .back-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.6s;
        }

        .back-link:hover {
            background: linear-gradient(135deg, rgba(118, 75, 162, 0.9) 0%, rgba(102, 126, 234, 0.9) 100%);
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.4);
        }

        .back-link:hover::before {
            left: 100%;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ—Å—Ç–∞ */
        #post-modal {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.95) 0%, rgba(26, 26, 46, 0.95) 100%);
            backdrop-filter: blur(30px);
        }

        #post-modal > div {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 28px;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.4);
            max-width: 650px;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ */
        #comments-modal {
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
        }

        #comments-modal > div {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.4);
            max-width: 600px;
            color: white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .feed-container {
                padding: 30px 15px;
            }

            .feed-title {
                font-size: 42px;
            }

            .feed-subtitle {
                font-size: 18px;
            }

            .posts-list {
                gap: 24px;
            }

            .post {
                min-height: 280px;
                border-radius: 20px;
                clip-path: inset(0 round 20px 20px 0 0);
            }

            .post-header {
                padding: 24px 20px 0;
            }

            .post-content {
                padding: 16px 20px;
            }

            .post-comments-link {
                padding: 12px 20px;
            }

            .post-actions {
                padding: 16px 20px 24px;
                flex-direction: column;
                gap: 8px;
                width: calc(100% - 40px);
            }

            .action-btn {
                padding: 14px 20px;
            }

            .image-container {
                height: 300px;
            }

            .back-link {
                padding: 16px 32px;
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            .feed-container {
                padding: 20px 10px;
            }

            .feed-title {
                font-size: 36px;
            }

            .post {
                clip-path: inset(0 round 12px 12px 0 0);
            }

            .post-header {
                padding: 20px 16px 0;
            }

            .post-content {
                padding: 12px 16px;
            }

            .post-comments-link {
                padding: 10px 16px;
            }

            .post-actions {
                padding: 12px 16px 20px;
            }

            .image-container {
                height: 250px;
                border-radius: 12px;
            }

            .back-link {
                padding: 14px 28px;
                font-size: 15px;
            }
        }

        @media (min-width: 769px) {
            .image-container {
                height: 300px;
            }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞–Ω–∞–ª–æ–≤ */
        .channel-message {
            font-size: 18px !important; /* –ë–æ–ª—å—à–µ —Ä–∞–∑–º–µ—Ä–∞ */
        }

        .channel-message.received {
            /* –í—Å–µ–≥–¥–∞ —Å–ª–µ–≤–∞ */
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–æ—Ñ–∏–ª—è */
        .profile-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            color: var(--text-color);
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            border-bottom-color: var(--accent-color);
            font-weight: bold;
        }

        .tab-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .profile-info {
            text-align: center;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤–∫–ª–∞–¥–æ–∫ –ø–æ–∏—Å–∫–∞ */
        .tab {
            cursor: pointer;
            padding: 8px 12px;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            border-bottom-color: var(--accent-color);
            font-weight: bold;
            color: var(--accent-color);
        }

        .tab:hover {
            background: rgba(255,255,255,0.1);
        }

        .profile-avatar img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 10px;
        }

        form label {
            display: block;
            margin-bottom: 10px;
        }

        form input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--input-bg);
            color: var(--text-color);
        }

        form button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background: var(--accent-color);
            color: white;
            cursor: pointer;
            margin-top: 10px;
        }

        #theme-options label {
            display: block;
            margin-bottom: 10px;
        }
    </style>
    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <script src="{{ url_for('static', filename='notification.js') }}"></script>
</head>
<body>
    <div class="telegram-layout">
        <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: —á–∞—Ç—ã –∏ –≥—Ä—É–ø–ø—ã -->
        <div class="chat-list-sidebar" id="chat-list">
            <!-- –ü—Ä–æ—Ñ–∏–ª—å –≤–≤–µ—Ä—Ö—É -->
            <div class="profile-section">
                <div class="profile-avatar-sidebar">
                    {% if user.avatar %}
                        <img src="/uploads/{{ user.avatar }}" alt="Avatar" class="profile-avatar-img">
                    {% else %}
                        <div class="profile-avatar-placeholder">{{ user.username[0].upper() }}</div>
                    {% endif %}
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">–í—Å–µ</button>
                <button class="filter-btn" data-filter="unread">–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ</button>
                <button class="filter-btn" data-filter="favorites">–ò–∑–±—Ä–∞–Ω–Ω—ã–µ</button>
            </div>

            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="header">
                <h3>–ß–∞—Ç—ã</h3>
                <div style="display: flex; align-items: center; gap: 12px;">
                   <button id="theme-toggle" onclick="toggleTheme()" style="font-size: 16px; background: none; border: none; cursor: pointer; color: var(--text-color);">‚òÄÔ∏è</button>
                   <a href="{{ url_for('logout') }}" class="logout">–í—ã–π—Ç–∏</a>
               </div>
            </div>

            <!-- –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
            <div class="bottom-nav">
                <div class="nav-item" onclick="window.location.href='/profile/{{ session.username }}'">
                    {% if user.avatar %}
                        <img src="/uploads/{{ user.avatar }}" alt="Avatar" class="nav-avatar">
                    {% else %}
                        <div class="nav-avatar">{{ user.username[0].upper() }}</div>
                    {% endif %}
                </div>
                <div class="nav-item" onclick="openFeed()">
                    <span class="nav-icon">üì±</span>
                </div>
                <div class="nav-item" onclick="openCreateModal()">
                    <span class="nav-icon">‚ûï</span>
                </div>
            </div>

            <!-- –ü–æ–∏—Å–∫ -->
                         <div class="search-container">
                             <div class="search-input-wrapper">
                                 <input type="text" id="search-input" placeholder="–ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..." class="search-input">
                                 <span class="search-icon">üîç</span>
                             </div>
                             <div class="search-tabs">
                                 <div class="tab active" data-type="users">–õ—é–¥–∏</div>
                                 <div class="tab" data-type="channels">–ö–∞–Ω–∞–ª—ã</div>
                                 <div class="tab" data-type="groups">–ì—Ä—É–ø–ø—ã</div>
                                 <div class="tab" data-type="all">–í—Å–µ</div>
                             </div>
                             <div id="search-results" style="display: none;"></div>
                             
                             <!-- –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ -->
                             <div class="advanced-search-options" style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; display: none;">
                                 <label style="display: block; margin-bottom: 8px; font-size: 14px;">
                                     <input type="checkbox" id="case-sensitive-search"> –£—á–∏—Ç—ã–≤–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä
                                 </label>
                                 <div class="search-type-selector" style="display: flex; gap: 5px; margin-bottom: 8px;">
                                     <button class="search-type-btn active" data-search-type="all">–í—Å–µ</button>
                                     <button class="search-type-btn" data-search-type="messages">–°–æ–æ–±—â–µ–Ω–∏—è</button>
                                     <button class="search-type-btn" data-search-type="posts">–ü–æ—Å—Ç—ã</button>
                                 </div>
                             </div>
                             
                             <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ -->
                             <div style="text-align: center; margin-top: 5px;">
                                 <button id="toggle-advanced-search" style="background: none; border: none; color: var(--text-color); font-size: 12px; cursor: pointer;">–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫</button>
                             </div>
                         </div>

            <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ -->
            <div class="chat-items">
                <!-- –ß–∞—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–Ω–æ -->
            </div>
        </div>

        <!-- –û–∫–Ω–æ —á–∞—Ç–∞ -->
        <div class="chat-window" id="chat-window" style="display: none;">
            <div class="chat-header">
                <button class="back-btn pc" onclick="goBack()">‚Üê –ù–∞–∑–∞–¥</button>
                <button class="back-btn mobile" onclick="goBack()">‚Üê</button>
                <h3 id="chat-username" onclick="openProfile()" style="cursor: pointer; color: #667eea;"></h3>
                <span class="status">–æ–Ω–ª–∞–π–Ω</span>

            </div>
             <div id="pinned-message"></div>
            <div class="messages" id="messages"></div>
            <div class="typing-indicator" id="typing" style="display: none; font-size: 13px; color: #666; padding: 16px; margin-top: -8px;"></div>
            <div id="chat-input" class="chat-input">
                <input type="text" id="msg-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." autofocus>
                <button id="emoji-btn">üòä</button>
                <button id="hold-record-btn">üé§</button>
                <span id="recording-timer" style="display:none; color: red;">0:00</span>
                <button id="send-btn">‚û§</button>
            </div>
            
            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ -->
            <div id="loading-earlier" style="display: none; text-align: center; padding: 10px; color: #666;">
                <div>–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π...</div>
            </div>
        </div>

        <!-- –û–∫–Ω–æ –ª–µ–Ω—Ç—ã -->
        <div class="feed-window" id="feed-view" style="display: none;">
            <div class="feed-header">
                <button class="back-btn pc" onclick="closeFeed()">‚Üê –ù–∞–∑–∞–¥</button>
                <button class="back-btn mobile" onclick="closeFeed()">‚Üê</button>
                <h3>–õ–µ–Ω—Ç–∞</h3>
            </div>
            <div class="posts-list" id="feed-posts" style="padding: 20px; overflow-y: auto; height: calc(100vh - 60px);"></div>
        </div>
    </div>

    

    <!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è —á–∞—Ç–∞ -->
    <div id="chat-context-menu" style="display: none; position: absolute; background: white; border: 1px solid #ccc; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; border-radius: 8px; overflow: hidden;">
        <div onclick="deleteCurrentChat()" style="padding: 12px 16px; cursor: pointer;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —á–∞—Ç</div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è -->
    <div id="message-context-menu" style="display: none; position: absolute; background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,249,250,0.95) 100%); border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 8px 25px rgba(0,0,0,0.15); z-index: 1000; border-radius: 12px; overflow: hidden; backdrop-filter: blur(10px);">
        <div onclick="editMessage()" class="context-menu-item" style="padding: 14px 18px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.3s ease;" onmouseover="this.style.background='rgba(102, 126, 234, 0.1)'" onmouseout="this.style.background='transparent'" id="edit-option">
            <span style="font-size: 16px;">‚úèÔ∏è</span>
            <span style="font-weight: 500;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
        </div>
        <div onclick="deleteMessage()" class="context-menu-item" style="padding: 14px 18px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.3s ease;" onmouseover="this.style.background='rgba(231, 76, 60, 0.1)'" onmouseout="this.style.background='transparent'">
            <span style="font-size: 16px;">üóëÔ∏è</span>
            <span style="font-weight: 500;">–£–¥–∞–ª–∏—Ç—å</span>
        </div>
        <div onclick="replyToMessageFunction()" class="context-menu-item" style="padding: 14px 18px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.3s ease;" onmouseover="this.style.background='rgba(52, 152, 219, 0.1)'" onmouseout="this.style.background='transparent'">
            <span style="font-size: 16px;">‚Ü©Ô∏è</span>
            <span style="font-weight: 500;">–û—Ç–≤–µ—Ç–∏—Ç—å</span>
        </div>
        <div onclick="pinMessage()" class="context-menu-item" style="padding: 14px 18px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.3s ease;" onmouseover="this.style.background='rgba(155, 89, 182, 0.1)'" onmouseout="this.style.background='transparent'" id="pin-option" style="display: none;">
            <span style="font-size: 16px;">üìå</span>
            <span style="font-weight: 500;">–ó–∞–∫—Ä–µ–ø–∏—Ç—å</span>
        </div>
        <div onclick="startForwardFromMessage()" class="context-menu-item" style="padding: 14px 18px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.3s ease;" onmouseover="this.style.background='rgba(255, 152, 0, 0.1)'" onmouseout="this.style.background='transparent'">
            <span style="font-size: 16px;">‚û°Ô∏è</span>
            <span style="font-weight: 500;">–ü–µ—Ä–µ—Å–ª–∞—Ç—å</span>
        </div>
    </div>

    <!-- –≠–º–æ–¥–∑–∏-–ø–∞–ª–∏—Ç—Ä–∞ -->
<div id="emoji-picker" style="display: none; grid-template-columns: repeat(8, 1fr); gap: 8px; padding: 10px; background: var(--header-bg); border-radius: 12px; position: absolute; bottom: 70px; right: 20px; z-index: 10; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
    <span class="emoji-btn">üòä</span>
    <span class="emoji-btn">üòÇ</span>
    <span class="emoji-btn">‚ù§Ô∏è</span>
    <span class="emoji-btn">üî•</span>
    <span class="emoji-btn">üöÄ</span>
    <span class="emoji-btn">üëç</span>
    <span class="emoji-btn">üéâ</span>
    <span class="emoji-btn">üëè</span>
    <span class="emoji-btn">üòé</span>
    <span class="emoji-btn">ü§î</span>
    <span class="emoji-btn">üí°</span>
    <span class="emoji-btn">üëÄ</span>
    <span class="emoji-btn">üôè</span>
    <span class="emoji-btn">üèÜ</span>
    <span class="emoji-btn">ü§ù</span>
    <span class="emoji-btn">‚ú®</span>
</div>

<script>
    const username = "{{ session.username }}";
    const user_id = "{{ session.user_id }}";
    const userChats = {{ user_chats|tojson|safe }};
    const userChannels = {{ user_channels|tojson|safe }};
    let currentRoom = null;
    let socket = null;
    let userStatuses = {}; // username ‚Üí { status: 'online', lastSeen: Date }
    let currentChatId = null;
    let currentGroupId = null;
    let currentMessageId = null;
    let currentMessageSender = null;
    let currentMessageText = null;
    var replyToMessage = null;
    let forwardMode = false;
    let selectedMessages = [];
    let currentChannelId = null;
    let currentFilter = 'users';

    // Voice recording variables
    let mediaRecorder = null;
    let recordedChunks = [];
    let recordingStartTime = null;
    let recordingInterval = null;

    socket = io({
        transports: ['polling']
    });

    window.chatSocket = socket;

    // –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–Ω—å—à–µ
    function openChat(otherUser) {
        document.getElementById('chat-username').textContent = otherUser;
        const room = [username, otherUser].sort().join('_').toLowerCase();
        currentRoom = room;

        _openChatCommon(room, false, otherUser);
    }

    function openGroup(groupName) {
        document.getElementById('chat-username').textContent = `# ${groupName}`;
        const room = `group_${groupName}`;
        currentRoom = room;

        _openChatCommon(room, true, null);
    }

    function openChannel(channelName) {
        console.log('DEBUG: Opening channel:', channelName);
        document.getElementById('chat-username').textContent = channelName;
        document.getElementById('chat-username').onclick = () => window.location.href = `/channel/${channelName}/settings`;
        document.getElementById('chat-username').style.cursor = 'pointer';
        document.getElementById('chat-username').style.color = '#667eea';
        const room = `channel_${channelName}`;
        currentRoom = room;

        fetch(`/user_channel_role/${channelName}`)
        .then(r => r.json())
        .then(data => {
            const canWrite = data.role === 'Admin';
            _openChatCommon(room, false, null, true, canWrite);  // isChannel = true, canWrite
        });
    }

    function goBack() {
        document.getElementById('chat-list').style.display = 'flex';
        document.getElementById('chat-window').style.display = 'none';
        document.getElementById('feed-view').style.display = 'none';
        currentRoom = null;
        socket.emit('set_chat_context', { room: '' });
        stopForward();
        // –£–±—Ä–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä chat –∏–∑ URL
        const url = new URL(window.location);
        url.searchParams.delete('chat');
        window.history.replaceState(null, null, url);
    }

    function openFeed() {
        if (window.innerWidth < 768) {
            document.getElementById('chat-list').style.display = 'none';
        }
        document.getElementById('chat-window').style.display = 'none';
        document.getElementById('feed-view').style.display = 'flex';
        
        // –°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
        feedCurrentPage = 1;
        feedIsLoading = false;
        feedHasMore = true;
        document.getElementById('feed-posts').innerHTML = '';
        
        loadFeed();
    }

    function closeFeed() {
        document.getElementById('feed-view').style.display = 'none';
        document.getElementById('chat-list').style.display = 'flex';
    }

    function openProfile(username) {
        console.log('Opening profile for:', username);
        if (!username) {
            username = document.getElementById('chat-username').textContent.trim();
        }
        if (username && !username.startsWith('#')) {
            window.location.href = '/profile/' + username;
        }
    }

    // === –ó–í–£–ö–ò ===
    function playMessageSound() {
        const audio = new Audio('{{ url_for("static", filename="message.mp3") }}');
        audio.play().catch(() => {});
    }

    function playChatSound() {
        const audio = new Audio('{{ url_for("static", filename="chat.mp3") }}');
        audio.play().catch(() => {});
    }

    // === –°–û–û–ë–©–ï–ù–ò–Ø ===
    socket.on('connect', () => {
        console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ');
    });

    // === –°—Ç–∞—Ç—É—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ===
    socket.on('user_status_update', (data) => {
        userStatuses[data.user] = {
            status: data.status,
            lastSeen: new Date()
        };
        updateChatListStatus();
    });

function updateChatListStatus() {
    document.querySelectorAll('.chat-item').forEach(el => {
        const user = el.querySelector('h4').textContent.replace('#', '').trim();
        const status = userStatuses[user] ? userStatuses[user].status : 'offline';
        const statusEl = el.querySelector('.status-dot');
        if (statusEl) {
            statusEl.style.background = status === 'online' ? '#07a74e' : '#ccc';
        }
    });
}

    // === "–ü–ï–ß–ê–¢–ê–ï–¢" ===
    socket.on('typing', function(data) {
        if (data.sender !== username) {
            document.getElementById('typing').style.display = 'block';
            document.getElementById('typing').textContent = data.sender + ' –ø–µ—á–∞—Ç–∞–µ—Ç...';
        }
    });

    socket.on('stop_typing', function() {
        document.getElementById('typing').style.display = 'none';
    });

    function addMessageToChat(msg, isGroup = false, isChannel = false) {
        console.log('DEBUG: addMessageToChat called for sender', msg.sender, 'msg:', msg.msg, 'isChannel:', isChannel);
        const messagesDiv = document.getElementById('messages');
        const el = document.createElement('div');
        // –î–ª—è –∫–∞–Ω–∞–ª–æ–≤ –≤—Å–µ–≥–¥–∞ —Å–ª–µ–≤–∞ –∏ –±–æ–ª—å—à–∏–π —Ä–∞–∑–º–µ—Ä
        el.className = 'message ' + (isChannel ? 'received channel-message' : (msg.sender === username ? 'sent' : 'received'));
        console.log('DEBUG: Message class:', el.className);
        el.dataset.msgId = msg.id || ('temp_' + Date.now());
        el.dataset.sender = msg.sender;
        el.dataset.parentMessageId = msg.parent_message_id;
        el.dataset.isForward = msg.is_forward || false;

        let senderName = '';
        if (isGroup && msg.sender !== username && !msg.is_forward) {
            senderName = `<div onclick="event.stopPropagation(); console.log('Clicked sender:', '${msg.sender}'); openProfile('${msg.sender}')" style="cursor: pointer; color: var(--accent-color); display: flex; align-items: center; gap: 5px; font-weight: 600;">`;
            if (msg.sender_avatar) {
                senderName += `<img src="/uploads/${msg.sender_avatar}" style="width: 20px; height: 20px; border-radius: 50%; object-fit: cover;" alt="Avatar">`;
            } else {
                senderName += `<div style="width: 20px; height: 20px; border-radius: 50%; background: var(--accent-color); display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: bold;">${msg.sender[0].toUpperCase()}</div>`;
            }
            senderName += `${msg.sender}</div>`;
        }

        let check = '';
        if (msg.sender === username) {
            if (msg.is_read || msg.status === 'read') {
                check = '<span class="check read">‚úì‚úì</span>';
            } else if (msg.status === 'delivered') {
                check = '<span class="check delivered">‚úì‚úì</span>';
            } else {
                check = '<span class="check">‚úì‚úì</span>';
            }
        }

        let replyBlock = '';
        if (msg.parent_message_id) {
            const parentSender = msg.parent_sender || msg.sender; // –î–ª—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            const parentMessage = msg.parent_message || msg.msg;
            const isForward = msg.is_forward;
            const title = isForward ? '–æ—Ç–≤–µ—Ç' : '–û—Ç–≤–µ—Ç';
            replyBlock = `
                <div class="reply-block ${isForward ? 'forward-block' : ''}" style="background: rgba(0,0,0,0.1); padding: 8px 12px; border-left: 3px solid var(--accent-color); margin-bottom: 8px; border-radius: 8px; font-size: 14px;">
                    <div style="font-weight: 600; color: var(--accent-color);">${title} <a href="/profile/${parentSender}" style="color: var(--accent-color); text-decoration: underline;" onclick="event.stopPropagation();">${parentSender}</a></div>
                    <div style="color: rgba(255,255,255,0.7); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${parentMessage}</div>
                </div>
            `;
        }

        let controls = '';
        if (msg.sender === username) {
            controls = '<span class="msg-control delete">üóëÔ∏è</span>';
        }

        let messageContent = '';
        if (msg.message_type === 'voice' && msg.audio_path) {
            messageContent = `
                <div class="audio-player" data-audio-path="/get_audio/${msg.audio_path}">
                    <button class="play-button" onclick="togglePlayPause(this)">‚ñ∂Ô∏è</button>
                    <div class="progress-container">
                        <div class="progress-bar" onclick="seekAudio(this, event)">
                            <div class="progress-fill"></div>
                        </div>
                        <div class="time-display">
                            <span class="current-time">0:00</span>
                            <span class="duration">0:00</span>
                        </div>
                    </div>
                    <audio preload="metadata">
                        <source src="/get_audio/${msg.audio_path}" type="audio/webm">
                    </audio>
                </div>
            `;
        } else {
            messageContent = `<p>${msg.message || msg.msg}${msg.edited ? ' <span class="edited">(–∏–∑–º–µ–Ω–µ–Ω–æ)</span>' : ''}</p>`;
        }

        el.innerHTML = `
            ${senderName}
            ${replyBlock}
            ${messageContent}
            <span class="time">${msg.timestamp || new Date().toLocaleTimeString('ru-RU', { timeZone: 'Europe/Moscow', hour: '2-digit', minute: '2-digit' })}</span>
            ${check}
            ${controls}
        `;
        messagesDiv.appendChild(el);

        // –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–∞–≤–æ–π –∫–Ω–æ–ø–∫–∏ –¥–ª—è –º–µ–Ω—é
        el.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            currentMessageId = el.dataset.msgId;
            currentMessageSender = msg.sender;
            currentMessageText = msg.message || msg.msg;
            const menu = document.getElementById('message-context-menu');
            const pinOption = document.getElementById('pin-option');
            if (currentRoom.startsWith('group_')) {
                pinOption.style.display = 'block';
            } else {
                pinOption.style.display = 'none';
            }
            menu.style.display = 'block';
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
        });

        // –î–ª–∏–Ω–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
        let touchTimer;
        el.addEventListener('touchstart', function(e) {
            touchTimer = setTimeout(() => {
                currentMessageId = el.dataset.msgId;
                currentMessageSender = msg.sender;
                currentMessageText = msg.message || msg.msg;
                const menu = document.getElementById('message-context-menu');
                const pinOption = document.getElementById('pin-option');
                if (currentRoom.startsWith('group_')) {
                    pinOption.style.display = 'block';
                } else {
                    pinOption.style.display = 'none';
                }
                menu.style.display = 'block';
                menu.style.left = e.touches[0].pageX + 'px';
                menu.style.top = e.touches[0].pageY + 'px';
            }, 500);
        });
        el.addEventListener('touchend', function() {
            clearTimeout(touchTimer);
        });
    }

    // === –ü–û–õ–£–ß–ï–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø ===
    socket.on('receive_message', function(data) {
        console.log('DEBUG: Receive message in', data.room, 'current', currentRoom, 'msg', data.msg, 'sender', data.sender);
        if (currentRoom === data.room) {
            console.log('DEBUG: Adding message to chat for sender', data.sender);
            addMessageToChat(data, currentRoom && currentRoom.startsWith('group_'), currentRoom && currentRoom.startsWith('channel_'));
            scrollToBottom();
            // –ó–≤—É–∫
            if (data.sender !== username) {
                playChatSound();
            }
        } else {
            // –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –¥—Ä—É–≥–æ–º —á–∞—Ç–µ - –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
            updateChatNotification(data.room, data.sender !== username);
            // –ó–≤—É–∫
            if (data.sender !== username) {
                playMessageSound();
                if (!document.hasFocus()) {
                    showNotification(data.sender, data.msg);
                }
            }
        }
    });

    // === –£–î–ê–õ–ï–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø ===
    socket.on('message_deleted', function(data) {
        const msg = document.getElementById('messages').querySelector(`[data-msg-id="${data.msg_id}"]`);
        if (msg) {
            msg.innerHTML = '<p><i>–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ</i></p>';
            msg.classList.add('deleted');
            msg.querySelector('.msg-control')?.remove();
        }
    });

    // === –ì–ê–õ–û–ß–ö–ò ===
    socket.on('message_status', function(data) {
        if (data.room && data.room !== currentRoom) return;
        const msg = document.getElementById('messages').querySelector(`[data-msg-id="${data.msg_id}"]`);
        if (msg) {
            const check = msg.querySelector('.check');
            if (data.status === 'delivered') {
                check.className = 'check delivered';
            } else if (data.status === 'read') {
                check.className = 'check read';
            }
        }
    });

    // === –ó–ê–ö–†–ï–ü ===
    socket.on('pinned_message', function(data) {
        if (currentRoom === `group_${data.group}`) {
            const pinned = document.getElementById('pinned-message');
            pinned.innerHTML = `
                <div style="font-size: 12px; color: #666; margin: 10px 0; padding: 8px 12px; background: var(--header-bg); border-left: 3px solid var(--accent-color); border-radius: 4px;">
                    –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: "${data.msg_id}"
                    <span onclick="unpinMessage('${data.group}')" style="float: right; cursor: pointer; opacity: 0.6;">‚úï</span>
                </div>
            `;
        }
    });

    socket.on('unpinned_message', function(data) {
        if (currentRoom === `group_${data.group}`) {
            document.getElementById('pinned-message').innerHTML = '';
        }
    });

    function _openChatCommon(room, isGroup, otherUser, isChannel = false, canWrite = false) {
        // –°–∫—Ä—ã–≤–∞—Ç—å sidebar —Ç–æ–ª—å–∫–æ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
        if (window.innerWidth < 768) {
            document.getElementById('chat-list').style.display = 'none';
        }
        document.getElementById('chat-window').style.display = 'flex';
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = '';
        document.getElementById('typing').style.display = 'none';
        document.getElementById('pinned-message').innerHTML = '';
        
        // –°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
        resetPagination();

        const chatInput = document.getElementById('chat-input');
        console.log('DEBUG: chatInput element:', chatInput, 'isChannel:', isChannel, 'canWrite:', canWrite);
        if (isChannel) {
            if (canWrite) {
                chatInput.style.display = 'flex';
            } else {
                chatInput.style.display = 'none';
                // –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å
                messagesDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–∞–Ω–∞–ª–µ.</div>';
            }
        } else {
            chatInput.style.display = 'flex';
        }

        socket.emit('set_chat_context', { room: room });
        socket.emit('join', { room: room });
        updateChatNotification(room, false); // –£–±—Ä–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        loadChatList(); // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫, —á—Ç–æ–±—ã —Å–±—Ä–æ—Å–∏—Ç—å unread_count

        // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –≥–∞–ª–æ—á–∫–∏ –Ω–∞ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ
        setTimeout(() => {
            console.log('Updating checks to read');
            document.querySelectorAll('.message.sent .check').forEach(check => {
                check.className = 'check read';
            });
        }, 100); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

        let url;
        if (isChannel) {
            url = `/channel/${room.replace('channel_', '')}/history`;
        } else if (isGroup) {
            url = `/group/${room.replace('group_', '')}/history`;
        } else {
            url = `/chat/${room.split('_').find(u => u !== username)}/history`;
        }

        fetch(url)
            .then(r => r.json())
            .then(data => {
                if (isChannel) {
                    currentChannelId = data.channel_id;
                    currentGroupId = null;
                    currentChatId = null;
                } else if (isGroup) {
                    currentGroupId = data.group_id;
                    currentChatId = null;
                    currentChannelId = null;
                } else {
                    currentChatId = data.chat_id;
                    currentGroupId = null;
                    currentChannelId = null;
                }

                if (data.pinned) {
                    document.getElementById('pinned-message').innerHTML = `
                        <div class="pinned-message" style="font-size: 14px; margin: 10px 0; padding: 12px 16px; position: relative;">
                            <div style="font-weight: 600; margin-bottom: 4px;">üìå –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
                            <div style="font-size: 16px; line-height: 1.4;">"${data.pinned.message}"</div>
                            <span onclick="unpinMessage('${room.replace('group_', '')}')" style="position: absolute; top: 10px; right: 10px; cursor: pointer; color: #666; font-size: 18px; transition: color 0.2s;">‚úï</span>
                        </div>
                    `;
                }

                if (!isGroup && !isChannel && data.messages.length === 0) {
                    // –ù–æ–≤—ã–π —á–∞—Ç, —É–≤–µ–¥–æ–º–∏—Ç—å –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    socket.emit('new_chat', { with: otherUser });
                }

                console.log('Loaded messages', data.messages.length, 'for room', room);
                data.messages.forEach(msg => {
                    addMessageToChat(msg, isGroup, isChannel);
                });
                scrollToBottom();
            });

        // –û—á–∏—Å—Ç–∫–∞
        ['receive_message', 'message_status', 'typing', 'stop_typing', 'message_deleted', 'pinned_message', 'unpinned_message'].forEach(e => socket.off(e));

        // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º
        socket.on('receive_message', function(data) {
            console.log('DEBUG: Internal receive_message for room', room, 'data.sender', data.sender, 'data.msg', data.msg);
            addMessageToChat(data, isGroup, isChannel);
            scrollToBottom();

            if (data.sender !== username) {
                if (currentRoom === data.room) {
                    playChatSound();
                } else {
                    playMessageSound();
                    if (!document.hasFocus()) {
                        showNotification(data.sender, data.msg);
                    }
                }
            }
        });

        socket.on('message_deleted', function(data) {
            const msg = messagesDiv.querySelector(`[data-msg-id="${data.msg_id}"]`);
            if (msg) {
                msg.innerHTML = '<p><i>–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ</i></p>';
                msg.classList.add('deleted');
                msg.querySelector('.msg-control')?.remove();
            }
        });

        socket.on('message_edited', function(data) {
            const msg = messagesDiv.querySelector(`[data-msg-id="${data.msg_id}"]`);
            if (msg) {
                const p = msg.querySelector('p');
                if (p) {
                    p.textContent = data.new_msg;
                    if (!p.querySelector('.edited')) {
                        p.innerHTML += ' <span class="edited">(–∏–∑–º–µ–Ω–µ–Ω–æ)</span>';
                    }
                }
            }
        });

        socket.on('message_status', function(data) {
            if (data.room && data.room !== currentRoom) return;
            const msg = messagesDiv.querySelector(`[data-msg-id="${data.msg_id}"]`);
            if (msg) {
                const check = msg.querySelector('.check');
                if (data.status === 'delivered') {
                    check.className = 'check delivered';
                } else if (data.status === 'read') {
                    check.className = 'check read';
                }
            }
        });

        socket.on('pinned_message', function(data) {
            document.getElementById('pinned-message').innerHTML = `
                <div class="pinned-message" style="font-size: 14px; margin: 10px 0; padding: 12px 16px; position: relative;">
                    <div style="font-weight: 600; margin-bottom: 4px;">üìå –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
                    <div style="font-size: 16px; line-height: 1.4;">"${data.msg}"</div>
                    <span onclick="unpinMessage('${data.group}')" style="position: absolute; top: 10px; right: 10px; cursor: pointer; color: #666; font-size: 18px; transition: color 0.2s;">‚úï</span>
                </div>
            `;
        });

        socket.on('unpinned_message', function(data) {
            document.getElementById('pinned-message').innerHTML = '';
        });

        socket.on('typing', function(data) {
            if (data.sender !== username) {
                document.getElementById('typing').style.display = 'block';
                document.getElementById('typing').textContent = data.sender + ' –ø–µ—á–∞—Ç–∞–µ—Ç...';
            }
        });

        socket.on('stop_typing', function() {
            document.getElementById('typing').style.display = 'none';
        });

        // –£–¥–∞–ª–µ–Ω–∏–µ
        messagesDiv.addEventListener('click', function(e) {
            if (e.target.classList.contains('delete')) {
                const msgId = e.target.closest('.message').dataset.msgId;
                if (msgId && msgId.startsWith('temp_')) return;
                if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
                    socket.emit('delete_message', { msg_id: msgId, room: currentRoom });
                }
            }
        });

        // –û—Ç–ø—Ä–∞–≤–∫–∞
        document.getElementById('send-btn').onclick = function() {
            console.log('DEBUG: send-btn onclick triggered');
            console.log('DEBUG: Socket connected:', socket.connected);
            console.log('DEBUG: Current room:', currentRoom);
            const msg = document.getElementById('msg-input').value.trim();
            console.log('DEBUG: msg trimmed:', msg);
            if (msg) {
                console.log('DEBUG: Sending message:', msg, 'to room:', room);
                const data = { room: currentRoom, msg: msg };
                if (replyToMessage) {
                    data.parent_message_id = replyToMessage.id;
                }
                socket.emit('send_message', data);
                document.getElementById('msg-input').value = '';
                cancelReply();
            } else {
                console.log('DEBUG: msg is empty, not sending');
            }
        };

        // –¢–æ–ª—å–∫–æ –º–µ–Ω—é —Å–æ–æ–±—â–µ–Ω–∏–π

        // –≠–º–æ–¥–∑–∏
        document.getElementById('emoji-btn').onclick = () => {
            const picker = document.getElementById('emoji-picker');
            picker.style.display = picker.style.display === 'grid' ? 'none' : 'grid';
        };

        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('emoji-btn')) {
                const input = document.getElementById('msg-input');
                if (input) {
                    input.value += e.target.textContent;
                    input.focus();
                }
            }
        });

        scrollToBottom();
        requestNotificationPermission();
    }

    // Voice recording functions
    async function startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
            recordedChunks = [];

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = () => {
                stream.getTracks().forEach(track => track.stop());
            };

            mediaRecorder.start();
            recordingStartTime = Date.now();
            document.getElementById('recording-timer').style.display = 'inline';
            recordingInterval = setInterval(updateTimer, 100);
        } catch (err) {
            console.error('Error starting recording:', err);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–∞');
        }
    }

    function updateTimer() {
        const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('recording-timer').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    async function stopAndSendRecording() {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
            clearInterval(recordingInterval);
            document.getElementById('recording-timer').style.display = 'none';

            if (recordedChunks.length > 0) {
                console.log('DEBUG: stopAndSendRecording called');
                await sendVoiceMessage();
            }
        }
    }

    async function sendVoiceMessage() {
        console.log('DEBUG: sendVoiceMessage called');
        console.log('DEBUG: user_id:', user_id);
        console.log('DEBUG: currentRoom:', currentRoom);
        console.log('DEBUG: currentChatId:', currentChatId, 'currentGroupId:', currentGroupId, 'currentChannelId:', currentChannelId);
        const target_id = currentChatId || currentGroupId || currentChannelId;
        console.log('DEBUG: target_id calculated as:', target_id);
        if (!target_id) {
            console.error('DEBUG: No target_id, cannot send voice message');
            alert('–ù–µ –≤—ã–±—Ä–∞–Ω —á–∞—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è');
            return;
        }
        console.log('DEBUG: recordedChunks length:', recordedChunks.length);
        const blob = new Blob(recordedChunks, { type: 'audio/webm' });
        console.log('DEBUG: blob size:', blob.size);
        const formData = new FormData();
        formData.append('file', blob, 'voice.webm');
        formData.append('user_id', user_id);
        formData.append('target_id', target_id);
        formData.append('message_type', 'voice');
        console.log('DEBUG: formData prepared');

        try {
            console.log('DEBUG: Starting file upload');
            console.log('DEBUG: Starting fetch to /upload_voice');
            const response = await fetch('/upload_voice', {
                method: 'POST',
                body: formData
            });
            console.log('DEBUG: Upload response:', response);
            console.log('DEBUG: upload_voice response status:', response.status);
            const data = await response.json();
            console.log('DEBUG: upload_voice response data:', data);
            console.log('DEBUG: File upload completed, success:', data.success);
            if (data.success) {
                console.log('DEBUG: Upload successful, audio_path:', data.audio_path);
                const messageData = {
                    room: currentRoom,
                    msg: '–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ',
                    message_type: 'voice',
                    audio_path: data.audio_path
                };
                if (replyToMessage) {
                    messageData.parent_message_id = replyToMessage.id;
                }
                console.log('DEBUG: About to emit send_message to socket');
                console.log('DEBUG: Emitting send_message with data:', messageData);
                socket.emit('send_message', messageData);
                document.getElementById('msg-input').value = '';
                cancelReply();
                console.log('DEBUG: Voice message sent successfully');
            } else {
                console.error('DEBUG: Upload failed with error:', data.error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ–ª–æ—Å–∞: ' + data.error);
            }
        } catch (err) {
            console.log('DEBUG: Upload error:', err);
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ–ª–æ—Å–∞');
        }
        recordedChunks = [];
    }

    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    let currentPage = 1;
    let isLoadingMore = false;
    let hasMoreMessages = true;

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∫—Ä–æ–ª–ª–∞ –¥–ª—è –ø–æ–¥–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
    document.getElementById('messages').addEventListener('scroll', function() {
        const scrollTop = this.scrollTop;
        if (scrollTop === 0 && !isLoadingMore && hasMoreMessages) {
            loadEarlierMessages();
        }
    });

    async function loadEarlierMessages() {
        if (isLoadingMore || !currentRoom || !hasMoreMessages) return;
        
        isLoadingMore = true;
        document.getElementById('loading-earlier').style.display = 'block';
        
        try {
            currentPage++;
            
            let url;
            if (currentRoom.startsWith('group_')) {
                url = `/group/${currentRoom.replace('group_', '')}/history?page=${currentPage}`;
            } else if (currentRoom.startsWith('channel_')) {
                url = `/channel/${currentRoom.replace('channel_', '')}/history?page=${currentPage}`;
            } else {
                const otherUser = currentRoom.split('_').find(u => u !== username);
                url = `/chat/${otherUser}/history?page=${currentPage}`;
            }
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.messages && data.messages.length > 0) {
                // –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–µ—Ä–µ–¥ —Ç–µ–∫—É—â–∏–º–∏
                const messagesContainer = document.getElementById('messages');
                const currentScrollTop = messagesContainer.scrollTop;
                const currentHeight = messagesContainer.scrollHeight;
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –Ω–∞—á–∞–ª–æ
                data.messages.forEach(msg => {
                    addMessageToChat(msg, currentRoom && currentRoom.startsWith('group_'), currentRoom && currentRoom.startsWith('channel_'));
                });
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é —Å–∫—Ä–æ–ª–ª–∞
                const newHeight = messagesContainer.scrollHeight;
                messagesContainer.scrollTop = currentScrollTop + (newHeight - currentHeight);
            } else {
                hasMoreMessages = false;
                document.getElementById('loading-earlier').innerHTML = '–ë–æ–ª—å—à–µ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç';
                setTimeout(() => {
                    document.getElementById('loading-earlier').style.display = 'none';
                }, 2000);
            }
        } catch (error) {
            console.error('Error loading earlier messages:', error);
            document.getElementById('loading-earlier').innerHTML = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π';
            setTimeout(() => {
                document.getElementById('loading-earlier').style.display = 'none';
            }, 2000);
        } finally {
            isLoadingMore = false;
        }
    }

    function resetPagination() {
        currentPage = 1;
        isLoadingMore = false;
        hasMoreMessages = true;
        document.getElementById('loading-earlier').style.display = 'none';
        document.getElementById('loading-earlier').innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π...';
    }

    function unpinMessage(group) {
        if (confirm('–û—Ç–∫—Ä–µ–ø–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
            socket.emit('unpin_message', { group: group });
        }
    }

    function createGroup() {
        const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã:");
        if (name) {
            socket.emit('create_group', { name: name });
        }
    }

    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –ª–µ–Ω—Ç—ã
    let feedCurrentPage = 1;
    let feedIsLoading = false;
    let feedHasMore = true;
    
    function loadFeed(reset = true) {
        if (reset) {
            feedCurrentPage = 1;
            feedHasMore = true;
            document.getElementById('feed-posts').innerHTML = '';
        }
        
        if (feedIsLoading || !feedHasMore) return;
        
        feedIsLoading = true;
        
        fetch(`/feed_data?page=${feedCurrentPage}&per_page=10`)
        .then(r => r.json())
        .then(data => {
            const container = document.getElementById('feed-posts');
            
            if (data.feed && data.feed.length > 0) {
                data.feed.forEach(post => {
                    const postEl = document.createElement('div');
                    postEl.className = 'post';
                    postEl.innerHTML = `
                        <div class="post-header">
                            <div class="post-avatar">
                                ${post.avatar ? `<img src="/uploads/${post.avatar}" alt="Avatar" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : post.username[0].toUpperCase()}
                            </div>
                            <div>
                                <h3 class="post-author">
                                    <i class="fas fa-user-circle"></i>
                                    ${post.username}
                                </h3>
                            </div>
                            <span class="post-date">
                                <i class="fas fa-clock"></i>
                                ${formatDate(post.created_at)}
                            </span>
                        </div>
    
                        <div class="post-content" data-post-id="${post.id}" data-content="${post.content.replace(/'/g, "\\'")}" oncontextmenu="showPostMenuForPost(event, this)">
                            ${post.image_url ? `<div class="image-container"><img class="post-thumbnail" src="/uploads/${post.image_url}" alt="Post image" onclick="openPostModal('${post.id}', '${post.content.replace(/'/g, "\\'")}', '${post.image_url}', ${post.likes_count || 0}, ${post.comments_count || 0}, ${post.reposts_count || 0})" onerror="this.style.display='none'"></div>` : ''}
                            <p class="post-text">${post.content}</p>
                        </div>
    
                        <div class="post-actions">
                            <button class="action-btn like-btn" onclick="toggleLike('${post.id}', this)" style="color: ${post.is_liked ? '#e74c3c' : '#999'};">
                                <i class="fas fa-heart"></i>
                                ${post.likes_count || 0}
                            </button>
                            <button class="action-btn comment-btn" onclick="showComments('${post.id}')">
                                <i class="fas fa-comment"></i>
                                ${post.comments_count || 0}
                            </button>
                            <button class="action-btn repost-btn" onclick="toggleRepost('${post.id}', this)" style="color: ${post.is_reposted ? '#27ae60' : '#999'};">
                                <i class="fas fa-retweet"></i>
                                ${post.reposts_count || 0}
                            </button>
                            <button class="action-btn react-btn" onclick="showReactionPicker('${post.id}', this)">
                                <i class="fas fa-smile"></i>
                                –†–µ–∞–∫—Ü–∏—è
                            </button>
                        </div>
                        <div class="post-comments-link">
                            <button class="show-comments-btn" onclick="showComments('${post.id}')">–∫–æ–º–µ–Ω—Ç—ã</button>
                        </div>
                        ${post.comments_count > 0 ? `<div class="post-comments-link"><button class="show-comments-btn" onclick="showComments('${post.id}')">üí¨ –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (${post.comments_count})</button></div>` : ''}
                        <div class="reactions" id="reactions-${post.id}">${renderReactions(post.reactions, post.id)}</div>
                    `;
                    container.appendChild(postEl);
                });
                
                feedCurrentPage++;
            } else {
                feedHasMore = false;
            }
            
            feedIsLoading = false;
        })
        .catch(error => {
            console.error('Error loading feed:', error);
            feedIsLoading = false;
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∫—Ä–æ–ª–ª–∞ –¥–ª—è –ø–æ–¥–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤
    document.getElementById('feed-posts').addEventListener('scroll', function() {
        if (this.scrollHeight - this.scrollTop <= this.clientHeight + 500 && !feedIsLoading && feedHasMore) {
            loadFeed(false);
        }
    });

    function openPostModal(id, content, imageUrl, likesCount, commentsCount, repostsCount) {
        // –ï—Å–ª–∏ –µ—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≥–∞–ª–µ—Ä–µ—é
        if (imageUrl) {
            // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤ –∏–∑ –≤—Å–µ—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –ª–µ–Ω—Ç–µ
            const allImages = collectAllPostImages();
            const startIndex = allImages.indexOf(imageUrl);
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≥–∞–ª–µ—Ä–µ—é —Å —Ç–µ–∫—É—â–∏–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
            openMediaGallery(allImages, startIndex);
        } else {
            // –ï—Å–ª–∏ –Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç
            document.getElementById('post-modal-content').textContent = content;
            document.getElementById('post-modal-image').src = '';
            document.getElementById('post-modal').style.display = 'flex';
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±–æ—Ä–∞ –≤—Å–µ—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–∑ –ø–æ—Å—Ç–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    function collectAllPostImages() {
        const images = [];
        const postImages = document.querySelectorAll('.post-thumbnail');
        postImages.forEach(img => {
            if (img.src.includes('/uploads/')) {
                const imagePath = img.src.split('/uploads/')[1];
                if (!images.includes(imagePath)) {
                    images.push(imagePath);
                }
            }
        });
        return images;
    }

    function closePostModal() {
        document.getElementById('post-modal').style.display = 'none';
    }

    function formatDate(dateString) {
        if (!dateString) return '–ù–µ–¥–∞–≤–Ω–æ';
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / (1000 * 60));
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

        if (diffMins < 1) return '–¢–æ–ª—å–∫–æ —á—Ç–æ';
        if (diffMins < 60) return `${diffMins} –º–∏–Ω –Ω–∞–∑–∞–¥`;
        if (diffHours < 24) return `${diffHours} —á –Ω–∞–∑–∞–¥`;
        if (diffDays < 7) return `${diffDays} –¥ –Ω–∞–∑–∞–¥`;
        return date.toLocaleDateString('ru-RU') + ' ' + date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
    }

    async function toggleLike(postId, btn) {
        const isLiked = btn.style.color === 'rgb(231, 76, 60)';
        const endpoint = isLiked ? '/unlike/' : '/like/';
        const res = await fetch(endpoint + postId, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
            btn.style.color = isLiked ? '#666' : '#e74c3c';
            const match = btn.textContent.match(/(\d+)/);
            const currentCount = match ? parseInt(match[0]) : 0;
            const count = currentCount + (isLiked ? -1 : 1);
            btn.innerHTML = btn.innerHTML.replace(/\d+/, count);
        }
    }

    async function toggleRepost(postId, btn) {
        const isReposted = btn.style.color === 'rgb(52, 152, 219)';
        const endpoint = isReposted ? '/unrepost/' : '/repost/';
        const res = await fetch(endpoint + postId, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
            btn.style.color = isReposted ? '#666' : '#3498db';
            const match = btn.textContent.match(/(\d+)/);
            const currentCount = match ? parseInt(match[0]) : 0;
            const count = currentCount + (isReposted ? -1 : 1);
            btn.innerHTML = btn.innerHTML.replace(/\d+/, count);
        }
    }

    function renderReactions(reactions, postId) {
        if (!reactions || Object.keys(reactions).length === 0) return '';
        let html = '';
        for (const [emoji, users] of Object.entries(reactions)) {
            const count = users.length;
            const usersList = users.map(u => u.username).join(', ');
            html += `<span class="reaction" onclick="showReactionUsers('${emoji}', '${usersList}', ${postId})">${emoji} ${count}</span> `;
        }
        return html;
    }

    function showReactionUsers(emoji, usersList, postId) {
        alert(`${emoji} –æ—Ç: ${usersList}`);
    }

    function showReactionPicker(postId, btn) {
        // –£–±–∏—Ä–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–∏–∫–µ—Ä
        document.querySelectorAll('.reaction-picker').forEach(p => p.remove());

        // –°–æ–∑–¥–∞–µ–º –ø–∏–∫–µ—Ä
        const picker = document.createElement('div');
        picker.className = 'reaction-picker';
        picker.innerHTML = `
            <span class="emoji-btn" data-emoji="üëç">üëç</span>
            <span class="emoji-btn" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</span>
            <span class="emoji-btn" data-emoji="üòÇ">üòÇ</span>
            <span class="emoji-btn" data-emoji="üòÆ">üòÆ</span>
            <span class="emoji-btn" data-emoji="üò¢">üò¢</span>
            <span class="emoji-btn" data-emoji="üò°">üò°</span>
            <span class="emoji-btn" data-emoji="üî•">üî•</span>
            <span class="emoji-btn" data-emoji="üéâ">üéâ</span>
        `;

        // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –ø–∏–∫–µ—Ä –≤–æ–∑–ª–µ –∫–Ω–æ–ø–∫–∏
        const rect = btn.getBoundingClientRect();
        picker.style.position = 'fixed';
        picker.style.left = `${rect.left}px`;
        picker.style.top = `${rect.bottom + 5}px`;
        picker.style.zIndex = '1000';

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        picker.addEventListener('click', async (e) => {
            if (e.target.classList.contains('emoji-btn')) {
                const emoji = e.target.dataset.emoji;
                await addReaction(postId, emoji);
                picker.remove();
                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–µ–Ω—Ç—É —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                loadFeed();
            }
        });

        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
        setTimeout(() => {
            document.addEventListener('click', function closePicker(e) {
                if (!picker.contains(e.target) && e.target !== btn) {
                    picker.remove();
                    document.removeEventListener('click', closePicker);
                }
            });
        }, 0);

        document.body.appendChild(picker);
    }

    async function addReaction(postId, emoji) {
        const res = await fetch(`/add_reaction/${postId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `emoji=${encodeURIComponent(emoji)}`
        });
        const data = await res.json();
        if (!data.success) {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
        }
    }

    let currentPostId = null;

    async function showComments(postId) {
        currentPostId = postId;
        const response = await fetch('/comments/' + postId);
        const data = await response.json();
        const commentsList = document.getElementById('comments-list');
        commentsList.innerHTML = '';
        if (data.comments && data.comments.length > 0) {
            data.comments.forEach(comment => {
                const commentDiv = document.createElement('div');
                commentDiv.style.cssText = 'background: linear-gradient(145deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.03) 100%); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); position: relative;';
                commentDiv.innerHTML = `
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-color), rgba(102, 126, 234, 0.8)); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; margin-right: 10px;">${comment.username[0].toUpperCase()}</div>
                        <strong style="color: white; font-size: 16px;">${comment.username}</strong>
                        <small style="color: rgba(255,255,255,0.6); margin-left: auto; font-size: 12px;">${formatDate(comment.created_at)}</small>
                    </div>
                    <p style="color: rgba(255,255,255,0.9); margin: 0; font-size: 15px; line-height: 1.5;">${comment.content}</p>
                `;
                commentsList.appendChild(commentDiv);
            });
        } else {
            commentsList.innerHTML = '<p style="color: rgba(255,255,255,0.7); text-align: center; padding: 20px;">–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>';
        }
        document.getElementById('comments-modal').style.display = 'flex';
    }

    function closeCommentsModal() {
        document.getElementById('comments-modal').style.display = 'none';
    }

    async function addComment(event) {
        event.preventDefault();
        const text = document.getElementById('comment-text').value.trim();
        if (!text) return;
        const formData = new FormData();
        formData.append('content', text);
        if (currentPostId) {
            const response = await fetch(`/comment/${currentPostId}`, { method: 'POST', body: formData });
            const data = await response.json();
            if (data.success) {
                document.getElementById('comment-text').value = '';
                showComments(currentPostId); // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
                // –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
                const commentBtn = document.querySelector(`[onclick*="showComments(${currentPostId})"]`);
                if (commentBtn) {
                    const match = commentBtn.textContent.match(/(\d+)/);
                    const currentCount = match ? parseInt(match[0]) : 0;
                    commentBtn.innerHTML = commentBtn.innerHTML.replace(/\d+/, currentCount + 1);
                }
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.error);
            }
        }
    }

    function scrollToBottom() {
        const div = document.getElementById('messages');
        div.scrollTop = div.scrollHeight;
    }

    function togglePlayPause(button) {
        const player = button.closest('.audio-player');
        const audio = player.querySelector('audio');
        const playButton = player.querySelector('.play-button');
        const progressFill = player.querySelector('.progress-fill');
        const currentTimeSpan = player.querySelector('.current-time');
        const durationSpan = player.querySelector('.duration');

        if (audio.paused) {
            audio.play();
            playButton.textContent = '‚è∏Ô∏è';
            player.classList.add('playing');
        } else {
            audio.pause();
            playButton.textContent = '‚ñ∂Ô∏è';
            player.classList.remove('playing');
        }

        audio.ontimeupdate = () => {
            const progress = (audio.currentTime / audio.duration) * 100;
            progressFill.style.width = progress + '%';
            currentTimeSpan.textContent = formatTime(audio.currentTime);
        };

        audio.onloadedmetadata = () => {
            durationSpan.textContent = formatTime(audio.duration);
        };
    }

    function seekAudio(progressBar, event) {
        const player = progressBar.closest('.audio-player');
        const audio = player.querySelector('audio');
        const rect = progressBar.getBoundingClientRect();
        const clickX = event.clientX - rect.left;
        const width = rect.width;
        const newTime = (clickX / width) * audio.duration;
        audio.currentTime = newTime;
    }

    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    window.onload = () => {
        const isDark = localStorage.getItem('theme') === 'dark';
        if (isDark) document.body.classList.add('dark');
        document.getElementById('theme-toggle').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';

        if (window.innerWidth >= 768) {
            document.getElementById('chat-list').style.display = 'flex';
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter
        document.getElementById('msg-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('send-btn').click();
            }
        });

        // Voice recording handlers
        const holdBtn = document.getElementById('hold-record-btn');
        holdBtn.addEventListener('mousedown', startRecording);
        holdBtn.addEventListener('mouseup', stopAndSendRecording);
        holdBtn.addEventListener('mouseleave', stopAndSendRecording);
        holdBtn.addEventListener('touchstart', startRecording);
        holdBtn.addEventListener('touchend', stopAndSendRecording);

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
        loadChatList();

        updateChatListStatus();
        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä chat –≤ URL –∏ –æ—Ç–∫—Ä—ã—Ç—å —á–∞—Ç
        const urlParams = new URLSearchParams(window.location.search);
        const chatParam = urlParams.get('chat');
        if (chatParam && chatParam !== username) {
            openChat(chatParam);
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –¥–ª—è –ª–µ–Ω—Ç—ã
        feedCurrentPage = 1;
        feedIsLoading = false;
        feedHasMore = true;
    };

    document.getElementById('theme-toggle').onclick = () => {
        const isDark = document.body.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        document.getElementById('theme-toggle').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
    };

    // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
    window.addEventListener('load', function() {
        console.log('Setting up search');
        const searchInput = document.getElementById('search-input');
        const resultsDiv = document.getElementById('search-results');
        console.log('searchInput found:', !!searchInput);
        console.log('resultsDiv found:', !!resultsDiv);

        if (searchInput && resultsDiv) {
            console.log('Setting up search listeners');
            searchInput.addEventListener('input', function() {
                performSearch();
            });

            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è Enter, –Ω–æ —Å–µ–π—á–∞—Å input —É–∂–µ –∏—â–µ—Ç
                }
            });

            function performSearch() {
                const query = searchInput.value.trim();
                console.log('DEBUG: performSearch called with query:', query);
                if (query === '') {
                    resultsDiv.style.display = 'none';
                    return;
                }
                fetch('/search?q=' + encodeURIComponent(query))
                .then(r => r.json())
                .then(data => {
                    console.log('DEBUG: Search data received:', data);
                    resultsDiv.innerHTML = '';
                    // –û–±—â–∏–π –ø–æ–∏—Å–∫: –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –≤—Å–µ —Ç–∏–ø—ã
                    let results = [
                        ...(data.users || []).map(u => ({ ...u, type: 'user' })),
                        ...(data.groups || []).map(g => ({ ...g, type: 'group' })),
                        ...(data.channels || []).map(c => ({ ...c, type: 'channel' }))
                    ];
                    // –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ –∑–∞–ø—Ä–æ—Å—É
                    results = results.filter(item => {
                        const name = item.username || item.name;
                        return name && name.toLowerCase().includes(query.toLowerCase());
                    });
                    console.log('DEBUG: Filtered results:', results);
                    if (results.length > 0) {
                        results.forEach(item => {
                            const div = document.createElement('div');
                            div.style.display = 'flex';
                            div.style.alignItems = 'center';
                            div.style.cursor = 'pointer';
                            div.style.padding = '10px';
                            div.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
                            if (item.type === 'user') {
                                const avatarDiv = document.createElement('div');
                                if (item.avatar) {
                                    const img = document.createElement('img');
                                    img.src = '/uploads/' + item.avatar;
                                    img.style.width = '30px';
                                    img.style.height = '30px';
                                    img.style.borderRadius = '50%';
                                    img.style.objectFit = 'cover';
                                    avatarDiv.appendChild(img);
                                } else {
                                    avatarDiv.textContent = item.username[0].toUpperCase();
                                    avatarDiv.style.width = '30px';
                                    avatarDiv.style.height = '30px';
                                    avatarDiv.style.borderRadius = '50%';
                                    avatarDiv.style.background = 'var(--accent-color)';
                                    avatarDiv.style.display = 'flex';
                                    avatarDiv.style.alignItems = 'center';
                                    avatarDiv.style.justifyContent = 'center';
                                    avatarDiv.style.color = 'white';
                                    avatarDiv.style.fontWeight = 'bold';
                                }
                                div.appendChild(avatarDiv);
                                const textDiv = document.createElement('div');
                                textDiv.textContent = item.username;
                                textDiv.style.marginLeft = '10px';
                                textDiv.style.color = 'var(--text-color)';
                                div.appendChild(textDiv);
                                div.onclick = () => {
                                    window.location.href = '/profile/' + item.username;
                                    resultsDiv.style.display = 'none';
                                    searchInput.value = '';
                                };
                            } else if (item.type === 'group') {
                                const avatarDiv = document.createElement('div');
                                avatarDiv.textContent = '#';
                                avatarDiv.style.width = '30px';
                                avatarDiv.style.height = '30px';
                                avatarDiv.style.display = 'flex';
                                avatarDiv.style.alignItems = 'center';
                                avatarDiv.style.justifyContent = 'center';
                                avatarDiv.style.borderRadius = '50%';
                                avatarDiv.style.background = 'var(--accent-color)';
                                avatarDiv.style.color = 'white';
                                avatarDiv.style.fontWeight = 'bold';
                                div.appendChild(avatarDiv);
                                const textDiv = document.createElement('div');
                                textDiv.textContent = item.name;
                                textDiv.style.marginLeft = '10px';
                                textDiv.style.color = 'var(--text-color)';
                                div.appendChild(textDiv);
                                div.onclick = () => {
                                    openGroup(item.name);
                                    resultsDiv.style.display = 'none';
                                    searchInput.value = '';
                                };
                            } else if (item.type === 'channel') {
                                const avatarDiv = document.createElement('div');
                                avatarDiv.textContent = 'üì∫';
                                avatarDiv.style.width = '30px';
                                avatarDiv.style.height = '30px';
                                avatarDiv.style.display = 'flex';
                                avatarDiv.style.alignItems = 'center';
                                avatarDiv.style.justifyContent = 'center';
                                avatarDiv.style.borderRadius = '50%';
                                avatarDiv.style.background = 'var(--accent-color)';
                                avatarDiv.style.color = 'white';
                                avatarDiv.style.fontSize = '20px';
                                div.appendChild(avatarDiv);
                                const textDiv = document.createElement('div');
                                textDiv.textContent = item.name;
                                textDiv.style.marginLeft = '10px';
                                textDiv.style.color = 'var(--text-color)';
                                div.appendChild(textDiv);
                                div.onclick = () => {
                                    openChannel(item.name);
                                    resultsDiv.style.display = 'none';
                                    searchInput.value = '';
                                };
                            }
                            resultsDiv.appendChild(div);
                        });
                        resultsDiv.style.display = 'block';
                    } else {
                        resultsDiv.style.display = 'none';
                    }
                });
            }

            function switchTab(tab) {
                console.log('DEBUG: Switching to tab:', tab.dataset.type);
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                console.log('DEBUG: Active tabs count after switch:', document.querySelectorAll('.tab.active').length);
                console.log('DEBUG: Active tab element:', document.querySelector('.tab.active'));
                currentFilter = tab.dataset.type;
                loadChatList();
            }

            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    console.log('DEBUG: Tab clicked:', this.dataset.type);
                    switchTab(this);
                });
            });

            document.addEventListener('click', function(e) {
                if (!e.target.closest('#search-input') && !e.target.closest('#search-results')) {
                    resultsDiv.style.display = 'none';
                }
            });
        }
    });

    // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è —á–∞—Ç–∞
    document.addEventListener('contextmenu', function(e) {
        if (e.target.closest('.chat-window') && currentRoom) {
            e.preventDefault();
            const menu = document.getElementById('chat-context-menu');
            menu.style.display = 'block';
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
        }
    });

    document.addEventListener('click', function(e) {
        if (!e.target.closest('#chat-context-menu')) {
            document.getElementById('chat-context-menu').style.display = 'none';
        }
        if (!e.target.closest('#message-context-menu')) {
            document.getElementById('message-context-menu').style.display = 'none';
        }
    });

    function deleteCurrentChat() {
        document.getElementById('chat-context-menu').style.display = 'none';
        openDeleteModal();
    }

    function showMessageMenu(e, messageEl) {
        currentMessageId = messageEl.dataset.msgId;
        const menu = document.getElementById('message-context-menu');
        menu.style.display = 'block';
        menu.style.left = e.pageX + 'px';
        menu.style.top = e.pageY + 'px';
    }

    function editMessage() {
        const menu = document.getElementById('message-context-menu');
        menu.style.display = 'none';
        const msgEl = document.querySelector(`[data-msg-id="${currentMessageId}"]`);
        const currentText = msgEl ? msgEl.querySelector('p').textContent.replace(' (–∏–∑–º–µ–Ω–µ–Ω–æ)', '') : '';
        const modal = document.getElementById('edit-message-modal');
        document.getElementById('edit-message-text').value = currentText;
        modal.style.display = 'flex';
    }

    function saveEditedMessage() {
        const newMsg = document.getElementById('edit-message-text').value.trim();
        if (newMsg && currentMessageId) {
            socket.emit('edit_message', { msg_id: currentMessageId, new_msg: newMsg, room: currentRoom });
        }
        closeEditMessageModal();
    }

    function closeEditMessageModal() {
        document.getElementById('edit-message-modal').style.display = 'none';
    }

    function deleteMessage() {
        const menu = document.getElementById('message-context-menu');
        menu.style.display = 'none';
        if (currentMessageId) {
            showDeleteModal(currentMessageId);
        }
    }

    function showDeleteModal(messageId) {
        const modal = document.getElementById('delete-message-modal');
        if (!modal) {
            const newModal = document.createElement('div');
            newModal.id = 'delete-message-modal';
            newModal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; display: flex;
            `;
            newModal.innerHTML = `
                <div style="background: var(--bg-color); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); width: 400px; max-width: 90%;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 48px; color: #ff6b6b;">üóëÔ∏è</div>
                    </div>
                    <h3 style="margin-top: 0; color: var(--text-color);">–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?</h3>
                    <p style="color: #666; margin: 10px 0; line-height: 1.5;">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
                    <div style="display: flex; justify-content: center; gap: 10px;">
                        <button onclick="closeDeleteMessageModal()" style="padding: 10px 20px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-color); color: var(--text-color); cursor: pointer;">–û—Ç–º–µ–Ω–∞</button>
                        <button onclick="confirmDeleteMessage(${messageId})" style="padding: 10px 20px; border: none; border-radius: 8px; background: #ff6b6b; color: white; cursor: pointer; font-weight: 500;">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>
            `;
            document.body.appendChild(newModal);
        }
        modal.style.display = 'flex';
    }

    function closeDeleteMessageModal() {
        const modal = document.getElementById('delete-message-modal');
        if (modal) modal.style.display = 'none';
    }

    function confirmDeleteMessage(messageId) {
        socket.emit('delete_message', { msg_id: messageId, room: currentRoom });
        closeDeleteMessageModal();
    }

    function replyToMessageFunction() {
        const menu = document.getElementById('message-context-menu');
        menu.style.display = 'none';
        replyToMessage = { id: currentMessageId, sender: currentMessageSender, text: currentMessageText };
        const input = document.getElementById('msg-input');
        input.focus();
        input.placeholder = `–û—Ç–≤–µ—Ç–∏—Ç—å ${currentMessageSender}...`;
        // –ü–æ–∫–∞–∑–∞—Ç—å –±–ª–æ–∫ –æ—Ç–≤–µ—Ç–∞
        showReplyBlock(currentMessageSender, currentMessageText);
    }

    function showReplyBlock(sender, text) {
        let replyDiv = document.getElementById('reply-indicator');
        if (!replyDiv) {
            replyDiv = document.createElement('div');
            replyDiv.id = 'reply-indicator';
            replyDiv.style.cssText = `
                position: absolute;
                bottom: 70px;
                left: 20px;
                right: 120px;
                background: rgba(102, 126, 234, 0.1);
                border: 1px solid rgba(102, 126, 234, 0.3);
                border-radius: 12px;
                padding: 12px;
                backdrop-filter: blur(10px);
                z-index: 10;
            `;
            document.querySelector('.chat-input').appendChild(replyDiv);
        }
        replyDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-weight: 600; color: var(--accent-color); font-size: 14px;">–û—Ç–≤–µ—Ç ${sender}</div>
                    <div style="color: rgba(255,255,255,0.8); font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${text}</div>
                </div>
                <button onclick="cancelReply()" style="background: none; border: none; color: #666; cursor: pointer; font-size: 16px;">‚úï</button>
            </div>
        `;
    }

    function cancelReply() {
        replyToMessage = null;
        document.getElementById('msg-input').placeholder = '–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ...';
        const replyDiv = document.getElementById('reply-indicator');
        if (replyDiv) replyDiv.remove();
    }

    function toggleForwardMode() {
        if (forwardMode) {
            if (selectedMessages.length > 0) {
                forwardSelected();
            } else {
                stopForward();
            }
        } else {
            startForward();
        }
    }

    function startForward() {
        forwardMode = true;
        selectedMessages = [];
        console.log('[DEBUG] startForward: selectedMessages reset to []');
        document.querySelectorAll('#messages .message').forEach(msg => {
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'forward-checkbox';
            checkbox.style.cssText = 'position: absolute; left: 10px; top: 10px; z-index: 10;';
            checkbox.onchange = () => {
                const id = msg.dataset.msgId;
                if (checkbox.checked) {
                    if (!selectedMessages.includes(id)) {
                        selectedMessages.push(id);
                        console.log('[DEBUG] checkbox onchange: added', id, 'selectedMessages:', selectedMessages);
                    }
                } else {
                    selectedMessages = selectedMessages.filter(m => m !== id);
                    console.log('[DEBUG] checkbox onchange: removed', id, 'selectedMessages:', selectedMessages);
                }
            };
            msg.style.position = 'relative';
            msg.appendChild(checkbox);
        });
        document.getElementById('forward-mode-btn').textContent = '–ü–µ—Ä–µ—Å–ª–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ';
    }

    function stopForward() {
        console.log('[DEBUG] stopForward: clearing selectedMessages, current:', selectedMessages);
        selectedMessages.forEach(id => {
            const msgEl = document.querySelector(`[data-msg-id="${id}"]`);
            if (msgEl) msgEl.style.background = '';
        });
        selectedMessages = [];
        console.log('[DEBUG] stopForward: after reset, selectedMessages:', selectedMessages);
        const btn = document.getElementById('forward-selected-btn');
        if (btn) btn.style.display = 'none';
    }

    function forwardSelected() {
        if (selectedMessages.length === 0) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è');
        showForwardModal(selectedMessages);
        stopForward();
    }

    function showForwardModal(messageIds) {
        console.log('[DEBUG] showForwardModal called with:', messageIds, 'type:', typeof messageIds, 'isArray:', Array.isArray(messageIds));
        window.forwardMessageIds = Array.isArray(messageIds) ? messageIds : [messageIds];
        console.log('[DEBUG] window.forwardMessageIds set to:', window.forwardMessageIds);
        const modal = document.getElementById('forward-modal');
        console.log('[DEBUG] existing modal element:', modal);
        if (modal) modal.remove();
        const newModal = document.createElement('div');
        newModal.id = 'forward-modal';
        newModal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; display: flex;';
        newModal.innerHTML = `
            <div style="background: var(--bg-color); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); width: 400px; max-width: 90%;">
                <h3 style="margin-top: 0; color: var(--text-color);">–ü–µ—Ä–µ—Å–ª–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è</h3>
                <div id="forward-preview" style="max-height: 200px; overflow-y: auto; margin-bottom: 10px; border: 1px solid var(--border-color); padding: 10px; border-radius: 8px;"></div>
                <div id="forward-recipient-list" style="max-height: 200px; overflow-y: auto; margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 8px;"></div>
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button onclick="closeForwardModal()" style="padding: 8px 16px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-color); color: var(--text-color); cursor: pointer;">–û—Ç–º–µ–Ω–∞</button>
                    <button onclick="sendForward()" style="padding: 8px 16px; border: none; border-radius: 8px; background: var(--accent-color); color: white; cursor: pointer;">–ü–µ—Ä–µ—Å–ª–∞—Ç—å</button>
                </div>
            </div>
        `;
        document.body.appendChild(newModal);
        console.log('[DEBUG] new modal appended, newModal:', newModal);
        const preview = document.getElementById('forward-preview');
        preview.innerHTML = '<p style="font-weight: 600; margin: 0 0 10px;">–í—ã–±—Ä–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:</p>' + window.forwardMessageIds.map(id => {
            const msgEl = document.querySelector(`[data-msg-id="${id}"]`);
            const text = msgEl ? msgEl.querySelector('p').textContent : '–°–æ–æ–±—â–µ–Ω–∏–µ';
            return `<div style="background: rgba(0,0,0,0.1); padding: 4px 8px; margin: 2px 0; border-radius: 4px; font-size: 14px;">${text}</div>`;
        }).join('');
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
        fetch('/chat_list')
        .then(r => r.json())
        .then(data => {
            const listDiv = document.getElementById('forward-recipient-list');
            listDiv.innerHTML = '<p style="font-weight: 600; margin: 0 0 10px; padding: 10px;">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è:</p>';
            const allContacts = [...data.user_chats.map(u => ({ name: u.username, avatar: u.avatar })), ...data.user_groups.map(g => ({ name: g.name, avatar: null })), ...data.user_channels.map(c => ({ name: c.name, avatar: null }))];
            allContacts.forEach(contact => {
                const div = document.createElement('div');
                div.style.cssText = 'padding: 10px; cursor: pointer; border-bottom: 1px solid rgba(0,0,0,0.1); display: flex; align-items: center; gap: 10px;';
                const avatarHtml = contact.avatar ? `<img src="/uploads/${contact.avatar}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">` : `<div style="width: 32px; height: 32px; border-radius: 50%; background: var(--accent-color); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">${contact.name[0].toUpperCase()}</div>`;
                div.innerHTML = `${avatarHtml}<span>${contact.name}</span>`;
                div.onclick = () => {
                    window.selectedRecipient = contact.name;
                    document.querySelectorAll('#forward-recipient-list div').forEach(d => d.style.background = 'transparent');
                    div.style.background = 'rgba(102, 126, 234, 0.1)';
                };
                listDiv.appendChild(div);
            });
        });
        newModal.style.display = 'flex';
        console.log('[DEBUG] modal.style.display set to flex');
    }

    function closeForwardModal() {
        document.getElementById('forward-modal').style.display = 'none';
    }

    function sendForward() {
        const recipient = window.selectedRecipient;
        if (!recipient) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è');
        const messageIds = window.forwardMessageIds;
        console.log('[DEBUG] sendForward: messageIds:', messageIds, 'to', recipient);
        let sentCount = 0;
        messageIds.forEach(id => {
            console.log('[DEBUG] sendForward: sending fetch for id:', id);
            fetch('/forward_message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `message_id=${id}&recipient=${encodeURIComponent(recipient)}`
            }).then(r => {
                console.log('[DEBUG] sendForward: fetch response for id:', id, 'status:', r.status);
                if (r.ok) sentCount++;
                if (sentCount === messageIds.length) {
                    alert('–°–æ–æ–±—â–µ–Ω–∏—è –ø–µ—Ä–µ—Å–ª–∞–Ω—ã!');
                    closeForwardModal();
                    stopForward();
                }
            });
        });
    }

    function startForwardFromMessage() {
        const menu = document.getElementById('message-context-menu');
        menu.style.display = 'none';
        if (currentMessageId.startsWith('temp_')) {
            alert('–ù–µ–ª—å–∑—è –ø–µ—Ä–µ—Å—ã–ª–∞—Ç—å –Ω–µ–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è');
            return;
        }
        console.log('[DEBUG] startForwardFromMessage: currentMessageId:', currentMessageId, 'selectedMessages before:', selectedMessages);
        if (!selectedMessages.includes(currentMessageId)) {
            selectedMessages.push(currentMessageId);
            console.log('[DEBUG] startForwardFromMessage: added currentMessageId, selectedMessages:', selectedMessages);
        } else {
            console.log('[DEBUG] startForwardFromMessage: currentMessageId already in selectedMessages');
        }
        const msgEl = document.querySelector(`[data-msg-id="${currentMessageId}"]`);
        if (msgEl) msgEl.style.background = 'rgba(102, 126, 234, 0.3)';
        showForwardButton();
    }

    function showForwardButton() {
        if (selectedMessages.length === 0) {
            const btn = document.getElementById('forward-selected-btn');
            if (btn) btn.style.display = 'none';
            return;
        }
        let btn = document.getElementById('forward-selected-btn');
        if (!btn) {
            btn = document.createElement('button');
            btn.id = 'forward-selected-btn';
            btn.textContent = '–ü–µ—Ä–µ—Å–ª–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ';
            btn.onclick = () => {
                showForwardModal(selectedMessages);
            };
            btn.style.cssText = 'position: fixed; top: 10px; right: 10px; padding: 10px; background: var(--accent-color); color: white; border: none; border-radius: 8px; cursor: pointer; z-index: 1001; box-shadow: 0 2px 10px rgba(0,0,0,0.2);';
            document.body.appendChild(btn);
        }
        btn.style.display = 'block';
    }

    function pinMessage() {
        const menu = document.getElementById('message-context-menu');
        menu.style.display = 'none';
        if (currentMessageId && confirm('–ó–∞–∫—Ä–µ–ø–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
            const group = currentRoom.replace('group_', '');
            socket.emit('pin_message', { group: group, msg_id: currentMessageId });
        }
    }

    function forwardMessage() {
        const menu = document.getElementById('message-context-menu');
        menu.style.display = 'none';
        if (currentMessageId) {
            // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–µ—Ä–µ—Å—ã–ª–∫–∏
            showForwardModal(currentMessageId);
        }
    }



    function closeForwardModal() {
        const modal = document.getElementById('forward-modal');
        if (modal) modal.style.display = 'none';
    }



    function openDeleteModal() {
        const modal = document.getElementById('delete-modal');
        const title = modal.querySelector('h3');
        const desc = modal.querySelector('p');

        if (currentChatId) {
            title.textContent = '–£–¥–∞–ª–∏—Ç—å —á–∞—Ç?';
            desc.textContent = '–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —ç—Ç–æ–º —á–∞—Ç–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –Ω–∞–≤—Å–µ–≥–¥–∞. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.';
        } else if (currentGroupId) {
            title.textContent = '–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É?';
            desc.textContent = '–ì—Ä—É–ø–ø–∞ –∏ –≤—Å–µ –µ—ë —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –Ω–∞–≤—Å–µ–≥–¥–∞. –£—á–∞—Å—Ç–Ω–∏–∫–∏ –ø–æ—Ç–µ—Ä—è—é—Ç –¥–æ—Å—Ç—É–ø. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.';
        }

        modal.style.display = 'flex';
    }

    function closeDeleteModal() {
        document.getElementById('delete-modal').style.display = 'none';
    }

    function confirmDelete() {
        if (currentChatId) {
            fetch('/delete_chat/' + currentChatId, { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    closeDeleteModal();
                    goBack();
                    location.reload(); // –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            });
        } else if (currentGroupId) {
            const groupName = currentRoom.replace('group_', '');
            fetch('/delete_group/' + groupName, { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    closeDeleteModal();
                    goBack();
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            });
        }
    }

    function openCreateGroupModal() {
        document.getElementById('create-group-modal').style.display = 'flex';
        document.getElementById('group-name-input').focus();
        loadGroupMembers();
    }

    function closeCreateGroupModal() {
        document.getElementById('create-group-modal').style.display = 'none';
        document.getElementById('group-name-input').value = '';
        document.getElementById('group-members').innerHTML = '';
    }

    function loadGroupMembers() {
        const membersDiv = document.getElementById('group-members');
        membersDiv.innerHTML = '';
        // –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∫–æ—Ç–æ—Ä—ã–º–∏ –µ—Å—Ç—å —á–∞—Ç
        userChats.forEach(user => {
            const label = document.createElement('label');
            label.style.display = 'flex';
            label.style.alignItems = 'center';
            label.style.marginBottom = '8px';
            label.dataset.username = user.username.toLowerCase(); // –î–ª—è –ø–æ–∏—Å–∫–∞
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = user.username;
            checkbox.style.marginRight = '8px';
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.textContent = user.username[0].toUpperCase();
            avatar.style.width = '32px';
            avatar.style.height = '32px';
            avatar.style.marginRight = '8px';
            const name = document.createElement('span');
            name.textContent = user.username;
            label.appendChild(checkbox);
            label.appendChild(avatar);
            label.appendChild(name);
            membersDiv.appendChild(label);
        });

        // –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∏—Å–∫–∞
        const searchInput = document.getElementById('group-members-search');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                const labels = membersDiv.querySelectorAll('label');
                labels.forEach(label => {
                    const username = label.dataset.username;
                    if (username.includes(query)) {
                        label.style.display = 'flex';
                    } else {
                        label.style.display = 'none';
                    }
                });
            });
        }
    }

    function createGroup() {
        const name = document.getElementById('group-name-input').value.trim();
        if (!name) return;
        const selectedMembers = Array.from(document.querySelectorAll('#group-members input[type="checkbox"]:checked')).map(cb => cb.value);
        socket.emit('create_group', { name: name, members: selectedMembers });
        closeCreateGroupModal();
    }

    function openCreateModal() {
        document.getElementById('create-modal').style.display = 'flex';
    }

    function closeCreateModal() {
        document.getElementById('create-modal').style.display = 'none';
    }

    function openCreateChannelModal() {
        closeCreateModal();
        document.getElementById('create-channel-modal').style.display = 'flex';
        document.getElementById('channel-name-input').focus();
    }

    function closeCreateChannelModal() {
        document.getElementById('create-channel-modal').style.display = 'none';
        document.getElementById('channel-name-input').value = '';
        document.getElementById('channel-description-input').value = '';
        document.getElementById('channel-private-input').checked = false;
    }

    function createChannel() {
        const name = document.getElementById('channel-name-input').value.trim();
        const description = document.getElementById('channel-description-input').value.trim();
        const isPrivate = document.getElementById('channel-private-input').checked;
        if (!name) return alert('–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ');
        fetch('/create_channel', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `channel_name=${encodeURIComponent(name)}&description=${encodeURIComponent(description)}&is_private=${isPrivate}`
        }).then(r => r.json()).then(data => {
            if (data.success) {
                closeCreateChannelModal();
                loadChatList(); // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.error);
            }
        });
    }

    // –°–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –Ω–æ–≤–æ–π –≥—Ä—É–ø–ø—ã
    socket.on('group_created', function(data) {
        if (data.name) {
            addGroupToList(data.name);
        }
    });

    socket.on('channel_created', function(data) {
        loadChatList();
    });

    socket.on('update_chat_list', () => {
        loadChatList();
    });

    function loadChatList(filter = currentFilter) {
        console.log('Loading chat list with filter:', filter);
        fetch('/chat_list')
        .then(r => {
            console.log('Chat list response status:', r.status);
            return r.json();
        })
        .then(data => {
            console.log('Chat list data:', data);
            const container = document.querySelector('.chat-items');
            container.innerHTML = '';

            if (filter === 'users' || filter === 'all') {
                // –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                data.user_chats.forEach(user => {
                    const el = document.createElement('div');
                    el.className = 'chat-item';
                    el.dataset.room = [username, user.username].sort().join('_').toLowerCase();
                    el.onclick = () => openChat(user.username);
                    el.innerHTML = `
                        <div class="avatar">${user.avatar ? `<img src="/uploads/${user.avatar}" alt="Avatar" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : user.username[0].toUpperCase()}</div>
                        <div class="chat-info">
                            <h4>${user.username}${user.unread_count > 0 ? `<span class="unread-count">${user.unread_count}</span>` : ''}</h4>
                            <p>${user.last_message ? user.last_message.substring(0, 25) + (user.last_message.length > 25 ? '...' : '') : '–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —á–∞—Ç'}</p>
                        </div>
                    `;
                    container.appendChild(el);
                });
            }

            if (filter === 'groups' || filter === 'all') {
                // –î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—ã
                data.user_groups.forEach(g => {
                    const el = document.createElement('div');
                    el.className = 'chat-item';
                    el.dataset.room = `group_${g.name}`;
                    el.onclick = () => openGroup(g.name);
                    el.innerHTML = `
                        <div class="avatar">#</div>
                        <div class="chat-info">
                            <h4>#${g.name}${g.unread_count > 0 ? `<span class="unread-count">${g.unread_count}</span>` : ''}</h4>
                            <p>${g.last_message ? g.last_message.substring(0, 25) + (g.last_message.length > 25 ? '...' : '') : '–ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç'}</p>
                        </div>
                        <div class="status-dot" style="width: 10px; height: 10px; border-radius: 50%; background: #ccc;"></div>
                    `;
                    container.appendChild(el);
                });
            }

            if (filter === 'channels' || filter === 'all') {
                // –î–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–∞–ª—ã
                if (data.user_channels) {
                    data.user_channels.forEach(c => {
                        const el = document.createElement('div');
                        el.className = 'chat-item';
                        el.dataset.room = `channel_${c.name}`;
                        // –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç –∫–∞–Ω–∞–ª–∞
                        el.onclick = () => openChannel(c.name);
                        el.innerHTML = `
                            <div class="avatar">üì∫</div>
                            <div class="chat-info">
                                <h4>${c.name}</h4>
                                <p>–ö–∞–Ω–∞–ª</p>
                            </div>
                        `;
                        container.appendChild(el);
                    });
                }
            }

            updateChatListStatus();
        })
        .catch(err => console.error('Load chat list error:', err));
    }

    function addGroupToList(groupName) {
        // –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã, loadChatList –æ–±–Ω–æ–≤–∏—Ç –≤—Å—ë
        loadChatList();
    }

    function updateChatNotification(room, hasNew = true) {
        console.log('updateChatNotification', room, hasNew);
        const chatItem = document.querySelector(`.chat-item[data-room="${room}"]`);
        console.log('chatItem', chatItem);
        if (chatItem) {
            if (hasNew) {
                let badge = chatItem.querySelector('.new-msg-badge');
                if (!badge) {
                    badge = document.createElement('span');
                    badge.className = 'new-msg-badge';
                    badge.textContent = '‚Ä¢';
                    chatItem.querySelector('.chat-info').appendChild(badge);
                }
                chatItem.classList.add('has-new-msg');
            } else {
                chatItem.querySelector('.new-msg-badge')?.remove();
                chatItem.classList.remove('has-new-msg');
            }
        }
    }
    
    // === –†–ê–°–®–ò–†–ï–ù–ù–´–ô –ü–û–ò–°–ö ===
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö –æ–ø—Ü–∏–π –ø–æ–∏—Å–∫–∞
    document.getElementById('toggle-advanced-search').addEventListener('click', function() {
        const advancedOptions = document.querySelector('.advanced-search-options');
        if (advancedOptions.style.display === 'none' || advancedOptions.style.display === '') {
            advancedOptions.style.display = 'block';
            this.textContent = '–°–∫—Ä—ã—Ç—å –æ–ø—Ü–∏–∏';
        } else {
            advancedOptions.style.display = 'none';
            this.textContent = '–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫';
        }
    });
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∏–ø–∞ –ø–æ–∏—Å–∫–∞
    document.querySelectorAll('.search-type-btn').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('.search-type-btn').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
        });
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞
    document.getElementById('search-input').addEventListener('input', function() {
        const query = this.value.trim();
        if (query.length > 2) { // –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–∏—Å–∫ –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞ 3 —Å–∏–º–≤–æ–ª–æ–≤
            performSearch(query);
        } else {
            document.getElementById('search-results').style.display = 'none';
        }
    });
    
    // –í—ã–±–æ—Ä —Ç–∏–ø–∞ –ø–æ–∏—Å–∫–∞
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            currentFilter = this.getAttribute('data-type');
            
            // –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ —Å –Ω–æ–≤—ã–º —Ç–∏–ø–æ–º
            const query = document.getElementById('search-input').value.trim();
            if (query.length > 2) {
                performSearch(query);
            }
        });
    });
    
    // –§—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞
    function performSearch(query) {
        const searchType = document.querySelector('.search-type-btn.active').getAttribute('data-search-type');
        const caseSensitive = document.getElementById('case-sensitive-search').checked;
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–∏—Å–∫–∞
        const currentTabType = document.querySelector('.tab.active').getAttribute('data-type');
        
        if (currentTabType === 'all') {
            // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º –∏ –ø–æ—Å—Ç–∞–º
            fetch(`/advanced_search?q=${encodeURIComponent(query)}&type=${searchType}&case_sensitive=${caseSensitive}`)
                .then(response => response.json())
                .then(data => {
                    displayAdvancedSearchResults(data, query);
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ:', error);
                });
        } else {
            // –ü–æ–∏—Å–∫ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º, –∫–∞–Ω–∞–ª–∞–º –∏–ª–∏ –≥—Ä—É–ø–ø–∞–º (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞)
            fetch(`/search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    displayBasicSearchResults(data, query);
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ:', error);
                });
        }
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
    function displayAdvancedSearchResults(data, query) {
        const resultsContainer = document.getElementById('search-results');
        let html = '<div class="search-results-content" style="max-height: 300px; overflow-y: auto; padding: 10px;">';
        
        if (data.messages && data.messages.length > 0) {
            html += '<h4 style="margin: 10px 0 5px; color: #667eea;">–°–æ–æ–±—â–µ–Ω–∏—è:</h4>';
            data.messages.forEach(msg => {
                let context = '';
                if (msg.message_type === 'private') {
                    context = `–ß–∞—Ç —Å: ${msg.chat_partner}`;
                } else if (msg.message_type === 'group') {
                    context = `–ì—Ä—É–ø–ø–∞: ${msg.group_name}`;
                } else if (msg.message_type === 'channel') {
                    context = `–ö–∞–Ω–∞–ª: ${msg.channel_name}`;
                }
                
                html += `
                <div class="search-result-item" style="padding: 8px; border-bottom: 1px solid #eee; cursor: pointer;"
                     onclick="openSearchResult('${msg.message_type}', '${msg.chat_partner || msg.group_name || msg.channel_name || ''}')">
                    <div style="font-weight: bold; color: #333;">${msg.sender}</div>
                    <div style="font-size: 14px; color: #666; margin: 5px 0;">${context}</div>
                    <div style="font-size: 14px; color: #888;">${truncateText(msg.message, 100)}</div>
                    <div style="font-size: 12px; color: #aaa;">${formatDateTime(msg.timestamp)}</div>
                </div>`;
            });
        }
        
        if (data.posts && data.posts.length > 0) {
            html += '<h4 style="margin: 10px 0 5px; color: #667eea;">–ü–æ—Å—Ç—ã:</h4>';
            data.posts.forEach(post => {
                html += `
                <div class="search-result-item" style="padding: 8px; border-bottom: 1px solid #eee; cursor: pointer;"
                     onclick="openPost(${post.id})">
                    <div style="font-weight: bold; color: #333;">${post.username}</div>
                    <div style="font-size: 14px; color: #888;">${truncateText(post.content, 100)}</div>
                    <div style="font-size: 12px; color: #aaa;">${formatDateTime(post.created_at)}</div>
                </div>`;
            });
        }
        
        if ((!data.messages || data.messages.length === 0) && (!data.posts || data.posts.length === 0)) {
            html += '<div style="text-align: center; padding: 20px; color: #888;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
        }
        
        html += '</div>';
        resultsContainer.innerHTML = html;
        resultsContainer.style.display = 'block';
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
    function displayBasicSearchResults(data, query) {
        const resultsContainer = document.getElementById('search-results');
        let html = '<div class="search-results-content" style="max-height: 300px; overflow-y: auto; padding: 10px;">';
        
        if (data.users && data.users.length > 0) {
            html += '<h4 style="margin: 10px 0 5px; color: #667eea;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:</h4>';
            data.users.forEach(user => {
                html += `
                <div class="search-result-item" style="padding: 8px; border-bottom: 1px solid #eee; cursor: pointer;"
                     onclick="openChat('${user.username}')">
                    <div style="font-weight: bold; color: #333;">${user.username}</div>
                </div>`;
            });
        }
        
        if (data.groups && data.groups.length > 0) {
            html += '<h4 style="margin: 10px 0 5px; color: #667eea;">–ì—Ä—É–ø–ø—ã:</h4>';
            data.groups.forEach(group => {
                html += `
                <div class="search-result-item" style="padding: 8px; border-bottom: 1px solid #eee; cursor: pointer;"
                     onclick="openGroup('${group.name}')">
                    <div style="font-weight: bold; color: #333;">${group.name}</div>
                </div>`;
            });
        }
        
        if (data.channels && data.channels.length > 0) {
            html += '<h4 style="margin: 10px 0 5px; color: #667eea;">–ö–∞–Ω–∞–ª—ã:</h4>';
            data.channels.forEach(channel => {
                html += `
                <div class="search-result-item" style="padding: 8px; border-bottom: 1px solid #eee; cursor: pointer;"
                     onclick="openChannel('${channel.name}')">
                    <div style="font-weight: bold; color: #333;">${channel.name}</div>
                </div>`;
            });
        }
        
        if ((!data.users || data.users.length === 0) && (!data.groups || data.groups.length === 0) && (!data.channels || data.channels.length === 0)) {
            html += '<div style="text-align: center; padding: 20px; color: #888;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
        }
        
        html += '</div>';
        resultsContainer.innerHTML = html;
        resultsContainer.style.display = 'block';
    }
    
    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function truncateText(text, maxLength) {
        if (text.length <= maxLength) return text;
        return text.substr(0, maxLength) + '...';
    }
    
    function formatDateTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('ru-RU');
    }
    
    // –û—Ç–∫—Ä—ã—Ç–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–æ–∏—Å–∫–∞
    function openSearchResult(type, target) {
        if (type === 'private') {
            openChat(target);
        } else if (type === 'group') {
            openGroup(target);
        } else if (type === 'channel') {
            openChannel(target);
        }
        
        // –°–∫—Ä—ã—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
        document.getElementById('search-results').style.display = 'none';
        document.getElementById('search-input').value = '';
    }
    
    // –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ—Å—Ç–∞ (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
    function openPost(postId) {
        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –ø–æ—Å—Ç–æ–º –∏–ª–∏ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ—Å—Ç–∞
        // –í—Ä–µ–º–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
        alert('–û—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ—Å—Ç–∞ #' + postId);
    }
</script>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ —Å–æ–∑–¥–∞–Ω–∏—è -->
<div id="create-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, rgba(102, 126, 234, 0.9) 0%, rgba(118, 75, 162, 0.9) 100%); backdrop-filter: blur(25px); z-index: 1000; justify-content: center; align-items: center; animation: fadeInModal 0.4s ease-out;">
    <div style="background: linear-gradient(145deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 249, 250, 0.98) 100%); backdrop-filter: blur(30px); width: 95%; max-width: 400px; position: relative; margin: 30px auto; border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.3); padding: 40px; animation: slideInStats 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);">
        <button onclick="closeCreateModal()" style="position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.1); border: none; font-size: 20px; cursor: pointer; color: #666; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background 0.2s;">√ó</button>
        <div style="text-align: center; margin-bottom: 30px;">
            <h3 style="margin: 0; color: #333; font-size: 28px; font-weight: 800; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">–°–æ–∑–¥–∞—Ç—å –ì—Ä—É–ø–ø—É/–ö–∞–Ω–∞–ª—ã</h3>
            <p style="margin: 8px 0 0; color: #666; font-size: 16px;">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</p>
        </div>

        <div style="display: flex; flex-direction: column; gap: 15px;">
            <button onclick="openCreateGroupModal()" style="padding: 20px; border: 2px solid #e1e8ed; border-radius: 12px; background: white; color: #333; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s ease; text-align: left; display: flex; align-items: center; gap: 15px;">
                <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
                    <i class="fas fa-users" style="color: white; font-size: 18px;"></i>
                </div>
                <div>
                    <div style="font-weight: 700; margin-bottom: 4px;">–°–æ–∑–¥–∞—Ç—å –ì—Ä—É–ø–ø—É</div>
                    <div style="color: #666; font-size: 14px; font-weight: 400;">–û–±—â–µ–Ω–∏–µ —Å –¥—Ä—É–∑—å—è–º–∏</div>
                </div>
            </button>
            <button onclick="openCreateChannelModal()" style="padding: 20px; border: 2px solid #e1e8ed; border-radius: 12px; background: white; color: #333; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s ease; text-align: left; display: flex; align-items: center; gap: 15px;">
                <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(245, 87, 108, 0.3);">
                    <i class="fas fa-broadcast-tower" style="color: white; font-size: 18px;"></i>
                </div>
                <div>
                    <div style="font-weight: 700; margin-bottom: 4px;">–°–æ–∑–¥–∞—Ç—å –ö–∞–Ω–∞–ª</div>
                    <div style="color: #666; font-size: 14px; font-weight: 400;">–ü—É–±–ª–∏–∫–∞—Ü–∏–∏ –¥–ª—è –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤</div>
                </div>
            </button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã -->
<div id="create-group-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, rgba(102, 126, 234, 0.9) 0%, rgba(118, 75, 162, 0.9) 100%); backdrop-filter: blur(25px); z-index: 1000; justify-content: center; align-items: center; animation: fadeInModal 0.4s ease-out;">
    <div style="background: linear-gradient(145deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 249, 250, 0.98) 100%); backdrop-filter: blur(30px); width: 95%; max-width: 500px; position: relative; margin: 30px auto; border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.3); padding: 40px; max-height: calc(100vh - 60px); overflow-y: auto; animation: slideInStats 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);">
        <button onclick="closeCreateGroupModal()" style="position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.1); border: none; font-size: 20px; cursor: pointer; color: #666; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background 0.2s;">√ó</button>
        <div style="text-align: center; margin-bottom: 30px;">
            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);">
                <i class="fas fa-users" style="color: white; font-size: 20px;"></i>
            </div>
            <h3 style="margin: 0; color: #333; font-size: 28px; font-weight: 800; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É</h3>
            <p style="margin: 8px 0 0; color: #666; font-size: 16px;">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –¥—Ä—É–∑–µ–π –∏ –Ω–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ</p>
        </div>

        <div style="margin-bottom: 25px;">
            <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 16px;">
                <i class="fas fa-tag" style="margin-right: 8px; color: #667eea;"></i>
                –ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã
            </label>
            <input type="text" id="group-name-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã..." style="width: 100%; padding: 15px 20px; border: 2px solid #e1e8ed; border-radius: 12px; background: white; color: #333; font-size: 16px; transition: all 0.3s ease; box-sizing: border-box; outline: none;">
        </div>

        <div style="margin-bottom: 30px;">
            <label style="display: block; margin-bottom: 12px; color: #333; font-weight: 600; font-size: 16px;">
                <i class="fas fa-user-plus" style="margin-right: 8px; color: #667eea;"></i>
                –î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            </label>
            <div id="group-members" style="max-height: 250px; overflow-y: auto; border: 2px solid #e1e8ed; border-radius: 12px; padding: 15px; background: white;"></div>
        </div>

        <div style="display: flex; gap: 15px; justify-content: flex-end;">
            <button onclick="closeCreateGroupModal()" style="padding: 12px 24px; border: 2px solid #e1e8ed; border-radius: 12px; background: white; color: #666; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s ease;">–û—Ç–º–µ–Ω–∞</button>
            <button onclick="createGroup()" style="padding: 12px 24px; border: none; border-radius: 12px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞–Ω–∞–ª–∞ -->
<div id="create-channel-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, rgba(245, 87, 108, 0.9) 0%, rgba(240, 147, 251, 0.9) 100%); backdrop-filter: blur(25px); z-index: 1000; justify-content: center; align-items: center; animation: fadeInModal 0.4s ease-out;">
    <div style="background: linear-gradient(145deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 249, 250, 0.98) 100%); backdrop-filter: blur(30px); width: 95%; max-width: 500px; position: relative; margin: 30px auto; border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.3); padding: 40px; max-height: calc(100vh - 60px); overflow-y: auto; animation: slideInStats 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);">
        <button onclick="closeCreateChannelModal()" style="position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.1); border: none; font-size: 20px; cursor: pointer; color: #666; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background 0.2s;">√ó</button>
        <div style="text-align: center; margin-bottom: 30px;">
            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 15px; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; box-shadow: 0 8px 20px rgba(245, 87, 108, 0.3);">
                <i class="fas fa-broadcast-tower" style="color: white; font-size: 20px;"></i>
            </div>
            <h3 style="margin: 0; color: #333; font-size: 28px; font-weight: 800; background: linear-gradient(135deg, #f093fb, #f5576c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–∞–Ω–∞–ª</h3>
            <p style="margin: 8px 0 0; color: #666; font-size: 16px;">–î–µ–ª–∏—Ç–µ—Å—å –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º —Å –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º–∏</p>
        </div>

        <div style="margin-bottom: 25px;">
            <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 16px;">
                <i class="fas fa-tag" style="margin-right: 8px; color: #f5576c;"></i>
                –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞
            </label>
            <input type="text" id="channel-name-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞..." style="width: 100%; padding: 15px 20px; border: 2px solid #e1e8ed; border-radius: 12px; background: white; color: #333; font-size: 16px; transition: all 0.3s ease; box-sizing: border-box; outline: none;">
        </div>

        <div style="margin-bottom: 25px;">
            <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 16px;">
                <i class="fas fa-file-alt" style="margin-right: 8px; color: #f5576c;"></i>
                –û–ø–∏—Å–∞–Ω–∏–µ
            </label>
            <textarea id="channel-description-input" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞..." style="width: 100%; padding: 15px 20px; border: 2px solid #e1e8ed; border-radius: 12px; background: white; color: #333; font-size: 16px; transition: all 0.3s ease; box-sizing: border-box; outline: none; resize: vertical; min-height: 80px;"></textarea>
        </div>

        <div style="margin-bottom: 30px;">
            <label style="display: flex; align-items: center; margin-bottom: 12px; color: #333; font-weight: 600; font-size: 16px;">
                <input type="checkbox" id="channel-private-input" style="margin-right: 10px;">
                <i class="fas fa-lock" style="margin-right: 8px; color: #f5576c;"></i>
                –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–∞–Ω–∞–ª
            </label>
            <p style="color: #666; font-size: 14px; margin: 0;">–ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –∫–∞–Ω–∞–ª—ã —Ç—Ä–µ–±—É—é—Ç –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏</p>
        </div>

        <div style="display: flex; gap: 15px; justify-content: flex-end;">
            <button onclick="closeCreateChannelModal()" style="padding: 12px 24px; border: 2px solid #e1e8ed; border-radius: 12px; background: white; color: #666; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s ease;">–û—Ç–º–µ–Ω–∞</button>
            <button onclick="createChannel()" style="padding: 12px 24px; border: none; border-radius: 12px; background: linear-gradient(135deg, #f093fb, #f5576c); color: white; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);">–°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–¥–∞–ª–µ–Ω–∏—è —á–∞—Ç–∞/–≥—Ä—É–ø–ø—ã -->
<div id="delete-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: var(--bg-color); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); width: 400px; max-width: 90%;">
        <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 48px; color: #ff6b6b;">üóëÔ∏è</div>
        </div>
        <h3 style="margin-top: 0; color: var(--text-color);">–£–¥–∞–ª–∏—Ç—å —á–∞—Ç?</h3>
        <p style="color: #666; margin: 10px 0; line-height: 1.5;">–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —ç—Ç–æ–º —á–∞—Ç–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –Ω–∞–≤—Å–µ–≥–¥–∞. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
        <div style="display: flex; justify-content: center; gap: 10px;">
            <button onclick="closeDeleteModal()" style="padding: 10px 20px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-color); color: var(--text-color); cursor: pointer;">–û—Ç–º–µ–Ω–∞</button>
            <button onclick="confirmDelete()" style="padding: 10px 20px; border: none; border-radius: 8px; background: #ff6b6b; color: white; cursor: pointer; font-weight: 500;">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ—Å—Ç–∞ -->
<div id="post-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, rgba(0, 0, 0, 0.95) 0%, rgba(26, 26, 46, 0.95) 100%); backdrop-filter: blur(30px); z-index: 1000; justify-content: center; align-items: center; animation: fadeInModal 0.4s ease-out;">
    <div style="background: linear-gradient(145deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%); backdrop-filter: blur(30px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 28px; box-shadow: 0 30px 80px rgba(0, 0, 0, 0.4); max-width: 650px; max-height: 80%; overflow-y: auto; position: relative; padding: 40px; animation: slideInStats 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);">
        <button onclick="closePostModal()" style="position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.1); border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; color: white; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">√ó</button>
        <p id="post-modal-content" style="margin: 0 0 20px; font-size: 18px; line-height: 1.6; color: rgba(255,255,255,0.9); text-shadow: 0 1px 2px rgba(0,0,0,0.3);"></p>
        <img id="post-modal-image" style="max-width: 100%; border-radius: 16px; box-shadow: 0 8px 25px rgba(0,0,0,0.3);" alt="Post image" onerror="this.style.display='none'">
    </div>
</div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è -->
    <div id="edit-message-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: var(--bg-color); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); width: 400px; max-width: 90%;">
            <h3 style="margin-top: 0; color: var(--text-color);">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h3>
            <textarea id="edit-message-text" style="width: 100%; height: 100px; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--chat-bg); color: var(--text-color); resize: vertical;"></textarea>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px;">
                <button onclick="closeEditMessageModal()" style="padding: 8px 16px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-color); color: var(--text-color); cursor: pointer;">–û—Ç–º–µ–Ω–∞</button>
                <button onclick="saveEditedMessage()" style="padding: 8px 16px; border: none; border-radius: 8px; background: var(--accent-color); color: white; cursor: pointer;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
    <div id="comments-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: linear-gradient(145deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%); backdrop-filter: blur(30px); border: 2px solid rgba(255, 255, 255, 0.2); padding: 30px; border-radius: 20px; box-shadow: 0 40px 100px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.2); max-width: 700px; max-height: 85%; overflow-y: auto; position: relative; animation: modalFadeIn 0.3s ease-out;">
            <button onclick="closeCommentsModal()" style="position: absolute; top: 15px; right: 15px; background: rgba(255, 255, 255, 0.1); border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; color: white; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">√ó</button>
            <h3 style="margin-top: 0; color: white; font-size: 28px; font-weight: 700; text-align: center; margin-bottom: 25px; background: linear-gradient(45deg, #ffffff, #667eea); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
            <div id="comments-list" style="margin-bottom: 25px; max-height: 400px; overflow-y: auto;"></div>
            <form id="comment-form" onsubmit="addComment(event)" style="border-top: 1px solid rgba(255, 255, 255, 0.1); padding-top: 20px;">
                <textarea id="comment-text" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." style="width: 100%; padding: 15px; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 12px; background: rgba(255, 255, 255, 0.05); color: white; resize: vertical; min-height: 80px; font-size: 16px; outline: none; transition: border-color 0.3s;"></textarea>
                <button type="submit" style="margin-top: 15px; padding: 12px 30px; border: none; border-radius: 12px; background: linear-gradient(135deg, var(--accent-color), rgba(102, 126, 234, 0.8)); color: white; font-weight: 600; cursor: pointer; font-size: 16px; transition: all 0.3s; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <style>
        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.9) translateY(-20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        #comments-modal button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        #comments-modal textarea:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        #comments-modal button[type="submit"]:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
    </style>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≥–∞–ª–µ—Ä–µ–∏ -->
    <div id="media-gallery" style="display: none;">
        <div class="gallery-content">
            <div class="gallery-controls">
                <button id="prev-media-btn" class="control-btn" onclick="prevMedia()" style="display: none;">&#8249;</button>
                <button id="next-media-btn" class="control-btn" onclick="nextMedia()" style="display: none;">&#8250;</button>
            </div>
            
            <div class="media-counter" id="media-counter">0 / 0</div>
            
            <div id="media-container"></div>
            
            <button class="close-btn" onclick="closeMediaGallery()">&times;</button>
            
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="zoomOut()">-</button>
                <button class="zoom-btn" onclick="resetZoom()">100%</button>
                <button class="zoom-btn" onclick="zoomIn()">+</button>
            </div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∫—Ä–∏–ø—Ç—ã –≥–∞–ª–µ—Ä–µ–∏ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='gallery.css') }}">
    <script src="{{ url_for('static', filename='gallery.js') }}"></script>
</body>
</html>
