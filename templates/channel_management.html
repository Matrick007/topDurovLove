<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление каналом - {{ channel.name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

</head>
<body>
    <div class="channel-layout">
        <div class="channel-main">
            <div class="back-link" onclick="history.back()">
                <i class="fas fa-arrow-left"></i>
                Назад к каналу
            </div>

            <div class="tab-navigation">
                <button class="tab-button active" data-tab="settings"><i class="fas fa-cog"></i> Настройки</button>
                <button class="tab-button" data-tab="members"><i class="fas fa-users"></i> Участники</button>
                <button class="tab-button" data-tab="invites"><i class="fas fa-link"></i> Инвайты</button>
            </div>

            {% include 'channel_settings.html' %}
            {% include 'channel_members.html' %}
            {% include 'channel_invites.html' %}
        </div>

        <div class="channel-sidebar">
            <h3><i class="fas fa-info-circle"></i> Информация о канале</h3>
            <p><strong>Название:</strong> {{ channel.name }}</p>
            <p><strong>Описание:</strong> {{ channel.description or 'Нет описания' }}</p>
            <p><strong>Тип:</strong> {% if channel.is_private %}Приватный{% else %}Публичный{% endif %}</p>
            <p><strong>Создан:</strong> {{ channel.creator }}</p>
            <p><strong>Дата создания:</strong> {{ channel.created_at }}</p>
            <p><strong>Участников:</strong> {{ members|length }}</p>
            <p><strong>Инвайтов:</strong> {{ invites|length }}</p>
        </div>
    </div>

    <script>
        // Tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tabName = button.dataset.tab;
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                button.classList.add('active');
                document.getElementById(tabName).classList.add('active');
            });
        });

        // Set default active tab
        document.getElementById('settings').classList.add('active');

        // Existing functions
        function openContactsModal() {
            console.log('openContactsModal called');
            const modal = document.getElementById('contacts-modal');
            console.log('modal element:', modal);
            if (modal) {
                modal.style.display = 'flex';
                loadContacts();
            } else {
                console.error('contacts-modal not found');
            }
        }

        function closeContactsModal() {
            const modal = document.getElementById('contacts-modal');
            modal.style.display = 'none';
            document.getElementById('contacts-list').innerHTML = '';
        }

        function loadContacts() {
            console.log('loadContacts called');
            fetch('/chat_list')
            .then(r => r.json())
            .then(data => {
                console.log('chat_list data:', data);
                const contactsDiv = document.getElementById('contacts-list');
                console.log('contactsDiv:', contactsDiv);
                if (!contactsDiv) {
                    console.error('contacts-list not found');
                    return;
                }
                contactsDiv.innerHTML = '';

                const dataElement = document.getElementById('channel-members-data');
                console.log('channel-members-data element:', dataElement);
                const textContent = dataElement ? dataElement.textContent : '[]';
                console.log('textContent:', textContent);
                try {
                    const channelMembers = JSON.parse(textContent || '[]');
                    console.log('channelMembers parsed:', channelMembers);
                    const memberUsernames = channelMembers.map(m => m.username);
                } catch(e) {
                    console.error('Error parsing channelMembers:', e);
                    return;
                }

                const allContacts = [...data.user_chats.map(u => ({ name: u.username, avatar: u.avatar }))];

                allContacts.forEach(contact => {
                    if (memberUsernames.includes(contact.name)) return;

                    const div = document.createElement('div');
                    div.style.cssText = 'padding: 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 15px; transition: background 0.3s; border-radius: 8px; margin-bottom: 5px;';
                    div.dataset.username = contact.name;

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = contact.name;
                    checkbox.style.marginRight = '10px';

                    const avatarHtml = contact.avatar ? `<img src="/uploads/${contact.avatar}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">` : `<div style="width: 40px; height: 40px; border-radius: 50%; background: var(--accent-color); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px;">${contact.name[0].toUpperCase()}</div>`;

                    div.innerHTML = `${checkbox.outerHTML}${avatarHtml}<span style="flex: 1; color: var(--text-color); font-weight: 500;">${contact.name}</span>`;

                    div.onclick = function(e) {
                        if (e.target.type !== 'checkbox') {
                            const cb = this.querySelector('input[type="checkbox"]');
                            cb.checked = !cb.checked;
                        }
                        this.style.background = this.querySelector('input[type="checkbox"]').checked ? 'rgba(0, 136, 204, 0.1)' : 'transparent';
                    };

                    contactsDiv.appendChild(div);
                });
            });
        }

        function addSelectedContacts() {
            const selected = Array.from(document.querySelectorAll('#contacts-list input[type="checkbox"]:checked')).map(cb => cb.value);
            if (selected.length === 0) {
                alert('Выберите пользователей');
                return;
            }

            selected.forEach(username => {
                const formData = new FormData();
                formData.append('channel_name', '{{ channel.name }}');
                formData.append('member_username', username);

                fetch('/add_member_to_channel', {
                    method: 'POST',
                    body: formData
                }).then(r => r.json()).then(data => {
                    if (data.success) {
                        console.log('Добавлен:', username);
                    } else {
                        alert('Ошибка добавления ' + username + ': ' + data.error);
                    }
                });
            });

            closeContactsModal();
            setTimeout(() => location.reload(), 1000);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Ссылка скопирована!');
            }).catch(err => {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Ссылка скопирована!');
            });
        }

        // Handle invite form submission
        document.addEventListener('DOMContentLoaded', () => {
            const inviteForm = document.querySelector('.create-invite-form');
            if (inviteForm) {
                inviteForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(inviteForm);
                    fetch('/create_channel_invite', {
                        method: 'POST',
                        body: formData
                    }).then(r => r.json()).then(data => {
                        if (data.success) {
                            alert('Инвайт создан успешно!');
                            location.reload();
                        } else {
                            alert('Ошибка: ' + data.error);
                        }
                    }).catch(err => {
                        console.error('Error creating invite:', err);
                        alert('Ошибка при создании инвайта');
                    });
                });
            }
        });
    </script>
</body>
</html>