# Улучшенный поиск по сообщениям и постам

## Обзор

Реализован улучшенный поиск по содержимому сообщений и постов в приложении. Функционал включает:

- Глобальный поиск по всем сообщениям и постам
- Локальный поиск в рамках конкретного чата, группы или канала
- Поддержка поиска с учетом регистра и без него
- Оптимизация поиска с использованием индексов
- Интерфейс для ввода поискового запроса и отображения результатов

## Техническая реализация

### 1. Индексы для оптимизации поиска

Созданы следующие индексы для ускорения поиска:

- `idx_messages_content` - индекс по содержимому личных сообщений
- `idx_group_messages_content` - индекс по содержимому сообщений в группах
- `idx_channel_messages_content` - индекс по содержимому сообщений в каналах
- `idx_posts_content` - индекс по содержимому постов
- Комбинированные индексы для более эффективного поиска:
  - `idx_messages_content_sender`
  - `idx_group_messages_content_sender`
  - `idx_channel_messages_content_sender`
  - `idx_posts_content_user`

### 2. Функции поиска в utils.py

Реализованы следующие функции поиска:

#### Глобальный поиск:
- `search_messages_global(query, user_id, case_sensitive=False, limit=50, offset=0)` - поиск по всем типам сообщений
- `search_posts_global(query, user_id, case_sensitive=False, limit=50, offset=0)` - поиск по постам
- `search_all_content(query, user_id, case_sensitive=False, limit=50, offset=0)` - поиск по всему контенту

#### Локальный поиск:
- `search_messages_in_chat(chat_partner_username, query, user_id, case_sensitive=False, limit=50, offset=0)` - поиск в конкретном чате
- `search_messages_in_group(group_name, query, user_id, case_sensitive=False, limit=50, offset=0)` - поиск в конкретной группе
- `search_messages_in_channel(channel_name, query, user_id, case_sensitive=False, limit=50, offset=0)` - поиск в конкретном канале

### 3. API-маршруты в app.py

Добавлены следующие маршруты:

- `GET /advanced_search` - глобальный поиск по сообщениям и постам
- `GET /search_in_chat/<chat_partner>` - локальный поиск в чате
- `GET /search_in_group/<group_name>` - локальный поиск в группе
- `GET /search_in_channel/<channel_name>` - локальный поиск в канале

Параметры запросов:
- `q` - поисковый запрос
- `type` - тип поиска (all, messages, posts)
- `case_sensitive` - учитывать регистр (true/false)
- `limit` - ограничение количества результатов
- `offset` - смещение для пагинации

### 4. Интерфейс в index.html

Добавлены элементы интерфейса:

- Расширенные опции поиска с возможностью выбора:
  - Учет регистра
  - Тип поиска (все, сообщения, посты)
- Переключение между режимами поиска
- Отображение результатов поиска с контекстной информацией
- JavaScript-функции для обработки поисковых запросов

## Использование

### Глобальный поиск

Для выполнения глобального поиска:
1. Введите поисковый запрос в поле поиска
2. Выберите тип поиска (все, сообщения, посты)
3. При необходимости установите флажок "Учитывать регистр"
4. Результаты будут отображены с указанием контекста (чат, группа, канал, автор)

### Локальный поиск

Для поиска в конкретном чате/группе/канале:
1. Перейдите в нужный чат/группу/канал
2. Используйте специализированные функции поиска (если реализованы в интерфейсе)
3. Или используйте API-маршруты напрямую

## Оптимизация

- Использование SQLite индексов для ускорения поиска
- Поддержка пагинации для больших наборов результатов
- Эффективные SQL-запросы с фильтрацией по правам доступа

## Особенности

- Поиск учитывает права доступа пользователя
- Результаты отсортированы по времени (новые первыми)
- Поддержка различных типов контента (текст, изображения, голосовые сообщения)
- Совместимость с существующими функциями приложения